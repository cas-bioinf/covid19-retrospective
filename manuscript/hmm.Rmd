---
title: "HMM Model"
output: html_document
---


```{r setup}
devtools::load_all()
library(tidyverse)
options(mc.cores = parallel::detectCores())
rstan::rstan_options(auto_write = TRUE)
options(brms.backend = "cmdstanr")

theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()

if(length(unique(data$patient_data$patient_id)) != length(data$patient_data$patient_id)) {
  stop("FAil")
}
# warning("Subsetting data")
# set.seed(4568224)
# patients_to_use <- sample(data$patient_data$patient_id, size = 70)
# data <- filter_complete_data(data, patient_id %in% patients_to_use)

                          
wide <- data$marker_data_wide
                          
                          
cache_dir <- here::here("local_temp_data", "hmm")
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

do_pp_checks <- FALSE
hmm_hypothesis_res_list <- list()

cl <-  parallel::makePSOCKcluster(parallel::detectCores())

#Temporary hack
registerS3method("stan_log_lik", class = "rate_hmm", method = stan_log_lik.rate_hmm, envir = asNamespace("brms"))
```


# The overall approach for hidden Markov models

To complement the more traditionally used proportional hazards models we also use several variants of hidden Markov models (HMMs). A discrete random process $X_1, X_2, X_3, ...$  satisfies the Markov property whenever for all states $x$ and times $t$ we have $P(X_{t + 1} = x | X_1 = x_1, X_2 = x_2, ..., X_t = x_t) = P(X_{t+1} = x | X_t = x_t)$, i.e. when the process is "memoryless". If this process is unobservable, but we can observe another process $Y$ such that $P(Y_{t} = y | X_1 = x_1, X_2 = x_2, ..., X_n = x_n) = P(Y_{t} = y | X_t = x_t)$ we call the pair $(X, Y)$ a hidden Markov process.

We treat the breathing support required as a Markov process, either with states directly corresponding to the breathing support and directly observable (Fig. \@ref(fig:hmmstates)a), or with the states carrying an unobserved binary improving worsening component which is unobservable (Fig. \@ref(fig:hmmstates)b) while the breathing support dimension still being completely observable. The former completely observable model is called _simple_ in the following text while the latter is called _complex_. This is unlike many uses of HMMs where the observation process is usually described by a general observation matrix. The reason is that the breathing support actually used is very likely to correspond to the breathing support needed by the patient. In initial versions of our models we also tested models that treated the breathing support observed as noisy realisation of the actual state, but the fitted probabilities of such imprecise observations were always very low, so we ended up not using them.

Directly modelling the full transition matrix of the Markov process would not make best use of the data as we know there is additional structure expressed in the ordering of states, e.g. that the probability of being discharged from the "AA" state is higher than from the "Oxygen" state, or that transitioning to "Ventilated" is more likely from the "Oxygen" state than from the "AA" state. To incorporate this structure, we follow the approach outlined in [@http://zotero.org/users/5567156/items/F9K2L5Q8].

Here we define a _rate matrix_ $R$ so that for any two states $i \neq j$ $R_{i,j}$ is the rate of transition from $i$ to $j$. $R$ is intended to be sparse, i.e. $R_{i,j} \neq 0$ only for transitions explicitly intended to be modelled directly. Additionally the diagonal elements are set as $R_{i,i} = -\sum_{j \neq i} R_{i,j}$. 

```{r hmmstates, fig.cap="The Markov models used a) simple, b) complex. AA = Ambient air, Oxygen = Nasal oxygen, Ventilated = any form of ventilation, including non-invasive positive-pressure ventilation, mechanical ventilation and extra-corporeal membrane oxygenation. In all models the 'Death' and 'Discharged' states are terminal. In the second hidden Markov model (c), the 'Improving' and 'Worsening' variants of each non-terminal state are not observable - only the breathing support is observed and improving/worsening is inferred from progression of the disease." }
knitr::include_graphics(here::here("manuscript","static_figs","model_states.png"), auto_pdf = TRUE)
```

The evolution of the vector $p(t)$ of the state probabilities in continuous time $t$ is then given by the differential equation

$$
\frac{dp(t)}{dt} = Rp
$$

Given $p(0)$, the solution to this equation is:

$$
p(t) = \exp(tR)p(0)
$$

where $\exp$ is the matrix exponential. We can thus compute a discrete-time transition matrix $S = \exp(R)$ so that $p(t + 1) = Sp(t)$. The appeal of this approach is that we can enforce a lot of structure on the transition matrix while allowing positive probability for almost all transitions. In the case of the complex model, the full transition matrix would have 42 free parameters (no transitions from the "Death" and "Discharged states) while the rate matrix has only 13 free parameters. We could obviously have a sparse transition matrix, but that would make the model overly rigid as transitions that are not modeled directly but actually occur in the data (e.g. from "Oxygen" to "Discharged") would have zero probability.


Finally we put a mixed-effects linear predictor on each of the rates we model so that $R_{i,j} = \exp(\mu_{i,j})$. We build the model in the Stan language,  using the `brms` package to express the linear predictors.

As an additional structure, we consider _rate groups_ which are: "Improving" (from a breathing level to a better one, including "Discharged"), "Worsening" (from a breathing level to a worse one, not including "Death"), and "Death" (any transition to the "Death" state). In addition, the complex model has "To improving" and "To worsening" which correspond to the switches between the improving and worsening variants of each breathing level.

Below we use three types of models: simple with predictors acting on rate groups (i.e. assuming that any predictor has the same multiplicative effect on all rates in a group), simple with predictors acting on rates directly (i.e. a predictor can have different effect on each rate) and complex with predictors acting on rate groups.

```{r}
transform_serie_data <- function(raw_serie_data) {
  raw_serie_data  %>%
  mutate(.time = .time +1) %>% 
  filter(.time >= 1) %>%
  group_by(.serie) %>%
  filter(sum(!is.na(.observed)) > 1) %>%
  ungroup() %>%
  #Force explicit dummy coding for the models
  mutate(across(tidyselect::starts_with("took_"), as.integer),
         best_supportive_care = as.integer(best_supportive_care),
         is_male = as.integer(sex == "M")
         )
}

serie_data <- wide %>%
  inner_join(data$patient_data, by = c("hospital_id", "patient_id"), suffix = c("_admission", "")) %>% 
  mutate(.time = day, .serie = patient_id, .observed = breathing_s) %>%
  transform_serie_data()


serie_data_28 <- wide %>%
  right_join(crossing(data$patient_data, day = 0:28), by = c("hospital_id", "patient_id", "day"),  suffix = c("_admission", "")) %>%
  # group_by(patient_id) %>%
  # mutate(
  #   across(
  #     c(starts_with("took_"), all_of("best_supportive_care")),
  #     ~ if_else(is.na(.x) & day > max(day[!is.na(.x)]), .x[which.max(day[!is.na(.x)])], .x)
  #     ),
  # ) %>%
  # ungroup() %>%
  mutate(.time = day, .serie = patient_id, .observed = breathing_s) %>%
  transform_serie_data()

# Extend terminal states and took_XX data for serie_data_28
serie_data_28 <- serie_data_28 %>%
  group_by(.serie) %>%
  mutate(last_day = max(day[!is.na(.observed)]),
         last_state = .observed[day == last_day],
         .observed = if_else(last_state %in% c("Discharged", "Death") & is.na(.observed) & day > last_day,
                             last_state,
                             .observed)) %>%
  mutate(across(c(tidyselect::starts_with("took_"), all_of("best_supportive_care")), ~ if_else(is.na(.x), as.integer(any(.x != 0, na.rm = TRUE)), .x))) %>%
  ungroup()


# Check succesful extension
mismatches <- serie_data_28 %>% inner_join(serie_data, by = c("patient_id", "day")) %>%
  select(-starts_with("."), -last_day,  -last_state) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(!any_of(c("patient_id", "day")), names_to = c("col", "source"), names_sep = "\\.") %>%
  group_by(patient_id, day, col) %>%
  summarise(n_vals = length(unique(value)), .groups = "drop") %>%
  filter(n_vals > 1)

if(nrow(mismatches) > 0) {
  print(mismatches)
  stop("Mismatches in serie_data_28")
}


base_observed_state_data <- tibble(id = factor(disease_s_levels, levels = disease_s_levels), is_noisy = FALSE)

simple_hidden_state_data <- tibble(id = factor(disease_s_levels, levels = disease_s_levels)) %>% mutate( corresponding_obs = id)

simple_initial_states <- serie_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)

default_control <- list(adapt_delta = 0.9)
```



# Treatments - simple, effects on rate groups

## Only treatments

```{r}
trt_group_m1_hidden_state_data <- simple_hidden_state_data

trt_group_m1_observed_state_data <- base_observed_state_data

simple_rate_data <- rbind(
  tibble(.from = c("Oxygen", "Ventilated"), .to = "Death", rate_group = "death"),
  tibble(.from = "AA", .to = "Discharged", rate_group = "improve_one"),
  tibble(.from = breathing_s_levels[2 : length(breathing_s_levels)], .to = breathing_s_levels[1 : (length(breathing_s_levels) - 1)], rate_group = "improve_one"),
  tibble(.from = breathing_s_levels[1 : (length(breathing_s_levels) - 1)], .to = breathing_s_levels[2 : length(breathing_s_levels)], rate_group = "worsen_one")
) %>%
  mutate(.rate_id = factor(paste0(.from, "_", .to), levels = paste0(.from, "_", .to)),
         .from = factor(.from, levels = disease_s_levels),
         .to = factor(.to, levels = disease_s_levels)
  )

simple_initial_states <- serie_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)

trt_group_m1_prior = #brms::set_prior("normal(-2, 5)", "Intercept") +
  brms::set_prior("normal(-2, 5)", "b") +
  brms::set_prior("normal(0, 2)", "sd")

trt_group_m1_formula <- ~ 0 + .rate_id +  (0 + best_supportive_care + took_hcq + took_az + took_favipiravir + took_convalescent_plasma || rate_group)

```

For the simple model, the rates we model are:

```{r}
simple_rate_data  
```

The $\log(R_{i,j})$ elements are then modeled via the `brms` formula

```{r}
trt_group_m1_formula
```
I.e. there is a separate coefficient for each rate and then the other predictors act uniformly on each rate group.

This is the summary of the fitted coefficients.

```{r trt_group_m1}
trt_group_m1 <- brmshmmdata(trt_group_m1_formula, serie_data, 
                  simple_rate_data, simple_hidden_state_data, simple_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)

trt_group_m1_fit <- brmhmm(trt_group_m1, cache_file = paste0(cache_dir,"/trt_group_m1.rds"), control = default_control, init = 0.1, iter = 1500)

summary(trt_group_m1_fit$brmsfit)

```


```{r}
hmm_hypothesis_res_list[["trt_group_m1"]] <- evaluate_all_treatment_hypotheses(trt_group_m1_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m1_fit)
}
```


## Treatments + age + sex

```{r}
trt_group_m2_formula <- update.formula(trt_group_m1_formula,  ~ . +  (0 + age_norm + is_male || rate_group))

```


```{r trt_group_m2}
trt_group_m2 <- brmshmmdata(trt_group_m2_formula, serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, simple_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

trt_group_m2_fit <- brmhmm(trt_group_m2, cache_file = paste0(cache_dir,"/trt_group_m2.rds"), init = 0.1, control = default_control, iter = 1200)

#parnames(trt_group_m2_fit$brmsfit)
summary(trt_group_m2_fit$brmsfit)
```
```{r, fig.width=12, fig.height=12}
# 
#  
# bayesplot::mcmc_pairs(trt_group_m2_fit$brmsfit, regex_pars = "improve_one", np = nuts_params(trt_group_m2_fit$brmsfit))
# 
# 
# bayesplot::mcmc_parcoord(trt_group_m2_fit$brmsfit, regex_pars = "death", np = nuts_params(trt_group_m2_fit$brmsfit))
# bayesplot::mcmc_parcoord(trt_group_m2_fit$brmsfit, regex_pars = "worsen_one", np = nuts_params(trt_group_m2_fit$brmsfit))
```


```{r}

hmm_hypothesis_res_list[["trt_group_m2"]] <- evaluate_all_treatment_hypotheses(trt_group_m2_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive, age, sex", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```

```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m2_fit)
}
```


## Treatments + age + sex + hospital

```{r trt_group_m3}
trt_group_m3_formula <- update.formula(trt_group_m2_formula,  ~  . + (0 + .rate_id | hospital_id))

trt_group_m3 <- brmshmmdata(trt_group_m3_formula, serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, simple_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

trt_group_m3_fit <- brmhmm(trt_group_m3, cache_file = paste0(cache_dir,"/trt_group_m3.rds"), init = 0.1, control = default_control, iter = 1200)

summary(trt_group_m3_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_group_m3"]] <-  evaluate_all_treatment_hypotheses(trt_group_m3_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive, age, sex, hospital", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m3_fit)
}
```



## Treatments + age + sex + hospital, first wave only

```{r trt_group_m3_fw}
serie_data_fw <- serie_data %>% filter(first_wave)
simple_initial_states_fw <- serie_data_fw %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed) 


trt_group_m3_fw <- brmshmmdata(trt_group_m3_formula, serie_data_fw, 
                  simple_rate_data, trt_group_m1_hidden_state_data, simple_initial_states_fw, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

trt_group_m3_fw_fit <- brmhmm(trt_group_m3_fw, cache_file = paste0(cache_dir,"/trt_group_m3_fw.rds"), init = 0.1, control = default_control, iter = 1200)

summary(trt_group_m3_fw_fit$brmsfit)
```

```{r}
serie_data_28_fw = serie_data_28 %>% filter(first_wave)

hmm_hypothesis_res_list[["trt_group_m3_fw"]] <-  evaluate_all_treatment_hypotheses(trt_group_m3_fw_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive, age, sex, hospital, first_wave", model_check = "OK", cl = cl, serie_data_28 = serie_data_28_fw)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m3_fw_fit)
}
```


## Treatment + age + sex + hospital + comorbidities


```{r trt_group_m4}
trt_group_m4_formula <-  update.formula(trt_group_m3_formula,  ~ . + (comorbidities_sum || rate_group)) 

trt_group_m4 <- brmshmmdata(trt_group_m4_formula, serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, simple_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)


trt_group_m4_fit <- brmhmm(trt_group_m4, cache_file = paste0(cache_dir,"/trt_group_m4.rds"), init = 0.1, control = default_control, iter = 1200)

summary(trt_group_m4_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_group_m4"]] <-  evaluate_all_treatment_hypotheses(trt_group_m4_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive, age, sex, hospital, comorbidities", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m4_fit)
}
```

## Treatment + age + sex + hospital + comorbidities, first wave


```{r trt_group_m4_fw}
trt_group_m4_fw <- brmshmmdata(trt_group_m4_formula, serie_data_fw, 
                  simple_rate_data, trt_group_m1_hidden_state_data, simple_initial_states_fw, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)


trt_group_m4_fw_fit <- brmhmm(trt_group_m4_fw, cache_file = paste0(cache_dir,"/trt_group_m4_fw.rds"), init = 0.1, control = default_control, iter = 1200)

summary(trt_group_m4_fw_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_group_m4_fw"]] <-  evaluate_all_treatment_hypotheses(trt_group_m4_fw_fit, model_subgroup = "simple_group", adjusted ="all treatments, supportive, age, sex, hospital, comorbidities, first_wave", model_check = "OK", cl = cl, serie_data_28 = serie_data_28_fw)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_group_m4_fit)
}
```

# Treatments - effect on individual rates

## Only treatments

```{r trt_rate_m1}
trt_rate_m1_hidden_state_data <- simple_hidden_state_data

trt_rate_m1_observed_state_data <- base_observed_state_data

trt_rate_m1_rate_data <- simple_rate_data

trt_rate_m1_initial_states <- simple_initial_states

trt_rate_m1_prior = trt_group_m1_prior

trt_rate_m1_formula <- ~ 0 + .rate_id +  (0 + best_supportive_care + took_hcq + took_az + took_favipiravir + took_convalescent_plasma || .rate_id)

trt_rate_m1 <- brmshmmdata(trt_rate_m1_formula, serie_data, 
                  trt_rate_m1_rate_data, simple_hidden_state_data, simple_initial_states, prior = trt_rate_m1_prior,
                  observed_state_data = base_observed_state_data)

trt_rate_m1_fit <- brmhmm(trt_rate_m1, cache_file = paste0(cache_dir,"/trt_rate_m1.rds"), control = default_control, init = 0.1)

summary(trt_rate_m1_fit$brmsfit)
```


```{r}
hmm_hypothesis_res_list[["trt_rate_m1"]] <-  evaluate_all_treatment_hypotheses(trt_rate_m1_fit, model_subgroup = "simple_rate", adjusted ="all treatments, supportive", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_rate_m1_fit)
}
```


## Treatments + age + sex


```{r trt_rate_m2}
trt_rate_m2_formula <- update.formula(trt_rate_m1_formula,  ~ . +  (0 + age_norm + is_male || .rate_id))
trt_rate_m2 <- brmshmmdata(trt_rate_m2_formula, serie_data, 
                  trt_rate_m1_rate_data, trt_rate_m1_hidden_state_data, trt_rate_m1_initial_states, prior = trt_rate_m1_prior,
                  observed_state_data = trt_rate_m1_observed_state_data)

trt_rate_m2_fit <- brmhmm(trt_rate_m2, cache_file = paste0(cache_dir,"/trt_rate_m2.rds"), init = 0.1, control = default_control)

summary(trt_rate_m2_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_rate_m2"]] <-  evaluate_all_treatment_hypotheses(trt_rate_m2_fit, model_subgroup = "simple_rate", adjusted ="all treatments, supportive, age, sex", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```

```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_rate_m2_fit)
}
```


## Treatments + age + sex + hospital

```{r trt_rate_m3}
trt_rate_m3_formula <- update.formula(trt_rate_m2_formula,  ~  . + (0 + .rate_id | hospital_id))
trt_rate_m3 <- brmshmmdata(trt_rate_m3_formula, serie_data, 
                  trt_rate_m1_rate_data, trt_rate_m1_hidden_state_data, trt_rate_m1_initial_states, prior = trt_rate_m1_prior,
                  observed_state_data = trt_rate_m1_observed_state_data)

trt_rate_m3_fit <- brmhmm(trt_rate_m3, cache_file = paste0(cache_dir,"/trt_rate_m3.rds"), init = 0.1, control = default_control, iter = 1500)

summary(trt_rate_m3_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_rate_m3"]] <-  evaluate_all_treatment_hypotheses(trt_rate_m3_fit, model_subgroup = "simple_rate", adjusted ="all treatments, supportive, age, sex, hospital", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_rate_m3_fit)
}
```


## Treatments + age + sex + hospital, first_Wave

```{r trt_rate_m3_fw}
trt_rate_m3_fw <- brmshmmdata(trt_rate_m3_formula, serie_data_fw, 
                  trt_rate_m1_rate_data, trt_rate_m1_hidden_state_data, simple_initial_states_fw, prior = trt_rate_m1_prior,
                  observed_state_data = trt_rate_m1_observed_state_data)

trt_rate_m3_fw_fit <- brmhmm(trt_rate_m3_fw, cache_file = paste0(cache_dir,"/trt_rate_m3_fw.rds"), init = 0.1, control = default_control, iter = 1500)

summary(trt_rate_m3_fw_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_rate_m3_fw"]] <-  evaluate_all_treatment_hypotheses(trt_rate_m3_fw_fit, model_subgroup = "simple_rate", adjusted ="all treatments, supportive, age, sex, hospital, first_wave", model_check = "OK", cl = cl, serie_data_28 = serie_data_28_fw)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_rate_m3_fw_fit)
}
```




## Treatment + age + sex + hospital + comorbidities


```{r trt_rate_m4}
trt_rate_m4_formula <-  update.formula(trt_rate_m3_formula, ~ . + (comorbidities_sum || .rate_id))

trt_rate_m4 <- brmshmmdata(trt_rate_m4_formula, serie_data, 
                  trt_rate_m1_rate_data, trt_rate_m1_hidden_state_data, trt_rate_m1_initial_states, prior = trt_rate_m1_prior,
                  observed_state_data = trt_rate_m1_observed_state_data)

trt_rate_m4_fit <- brmhmm(trt_rate_m4, cache_file = paste0(cache_dir,"/trt_rate_m4.rds"), init = 0.1, control = default_control, iter = 1500)

summary(trt_rate_m4_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["trt_rate_m4"]] <- evaluate_all_treatment_hypotheses(trt_rate_m4_fit, model_subgroup = "simple_rate", adjusted ="all treatments, supportive, age, sex, hospital, comorbidities", model_check = "Suspicious", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(trt_rate_m4_fit)
}
```


# Markers


## D-dimer + hospital


```{r d_dimer_m1}
d_dimer_serie_data <- serie_data %>% 
  group_by(.serie) %>%
  filter(any(!is.na(d_dimer))) %>%
  ungroup() %>%
  compute_marker_peak(column_name = "d_dimer", new_column_name = "peak_d_dimer", initial_value = 0) %>%
  mutate(log_peak_d_dimer = log(peak_d_dimer + 1) - 4)

d_dimer_initial_states <- d_dimer_serie_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)


d_dimer_m1_formula <-  ~ 0 + .rate_id +  (0 + best_supportive_care || rate_group)  + (0 + .rate_id | hospital_id) + (log_peak_d_dimer || rate_group) 


d_dimer_m1 <- brmshmmdata(d_dimer_m1_formula, d_dimer_serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, d_dimer_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

d_dimer_m1_fit <- brmhmm(d_dimer_m1, cache_file = paste0(cache_dir,"/d_dimer_m1.rds"), init = 0.1, control = default_control, iter = 1500)

summary(d_dimer_m1_fit$brmsfit)
```

```{r}
draws <- tidybayes::tidy_draws(d_dimer_m1_fit$brmsfit)
hmm_hypothesis_res_list[["d_dimer_m1_death"]] <-
  bayesian_hypothesis_res_from_draws(
    draws = draws$`r_rate_group[death,log_peak_d_dimer]`,
    model = "HMMsimple_group",
    estimand = "log(HR)",
    hypothesis = hypotheses$d_dimer_increases_death,
    adjusted = "supportive, hospital",
    model_check = "Suspicious"
  )

```

```{r}
if(do_pp_checks) {
  do_common_pp_checks(d_dimer_m1_fit)
}
```

## D-dimer + age + sex + comorbidities

```{r}
d_dimer_m2_formula <-  update.formula(d_dimer_m1_formula, ~ . + (0 + age_norm + is_male || rate_group))


d_dimer_m2 <- brmshmmdata(d_dimer_m2_formula, d_dimer_serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, d_dimer_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

d_dimer_m2_fit <- brmhmm(d_dimer_m2, cache_file = paste0(cache_dir,"/d_dimer_m2.rds"), init = 0.1, control = default_control, iter = 1500)

summary(d_dimer_m2_fit$brmsfit)

```

```{r}
draws <- tidybayes::tidy_draws(d_dimer_m2_fit$brmsfit)
hmm_hypothesis_res_list[["d_dimer_m2_death"]] <-
  bayesian_hypothesis_res_from_draws(
    draws = draws$`r_rate_group[death,log_peak_d_dimer]`,
    model = "HMMsimple_group",
    estimand = "log(HR)",
    hypothesis = hypotheses$d_dimer_increases_death,
    adjusted = "supportive, age, sex, hospital",
    model_check = "Suspicious"
  )

```



## IL-6 + hospital


```{r}
IL_6_serie_data <- serie_data %>% 
  group_by(.serie) %>%
  filter(any(!is.na(IL_6))) %>%
  ungroup() %>%
  compute_marker_peak(column_name = "IL_6", new_column_name = "peak_IL_6", initial_value = 1) %>%
  mutate(log_peak_IL_6 = log(peak_IL_6))

IL_6_initial_states <- IL_6_serie_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)


IL_6_m1_formula <- ~ 0 + .rate_id +  (0 + best_supportive_care || rate_group)  + (0 + .rate_id | hospital_id) + (log_peak_IL_6 || rate_group) 

IL_6_m1 <- brmshmmdata(IL_6_m1_formula, IL_6_serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, IL_6_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

IL_6_m1_fit <- brmhmm(IL_6_m1, cache_file = paste0(cache_dir,"/IL_6_m1.rds"), init = 0.1, control = default_control, iter = 1500)

summary(IL_6_m1_fit$brmsfit)
```


```{r}
draws <- tidybayes::tidy_draws(IL_6_m1_fit$brmsfit)
hmm_hypothesis_res_list[["IL_6_m1_death"]] <-
  bayesian_hypothesis_res_from_draws(
    draws = draws$`r_rate_group[death,log_peak_IL_6]`,
    model = "HMMsimple_group",
    estimand = "log(HR)",
    hypothesis = hypotheses$IL_6_increases_death,
    adjusted = "supportive, hospital"
  )


```

```{r}
if(do_pp_checks) {
  do_common_pp_checks(IL_6_m1_fit)
}
```



## IL_6 + age + sex + comorbidities

```{r}
IL_6_m2_formula <-  update.formula(IL_6_m1_formula, ~ . + (0 + age_norm + is_male || rate_group))

IL_6_m2 <- brmshmmdata(IL_6_m2_formula, IL_6_serie_data, 
                  simple_rate_data, trt_group_m1_hidden_state_data, IL_6_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = trt_group_m1_observed_state_data)

IL_6_m2_fit <- brmhmm(IL_6_m2, cache_file = paste0(cache_dir,"/IL_6_m2.rds"), init = 0.1, control = default_control, iter = 1500)

summary(IL_6_m2_fit$brmsfit)
```

```{r}
draws <- tidybayes::tidy_draws(IL_6_m2_fit$brmsfit)
hmm_hypothesis_res_list[["IL_6_m2_death"]] <-
  bayesian_hypothesis_res_from_draws(
    draws = draws$`r_rate_group[death,log_peak_IL_6]`,
    model = "HMMsimple_group",
    estimand = "log(HR)",
    hypothesis = hypotheses$IL_6_increases_death,
    adjusted = "supportive, age, sex, hospital"
  )

```


# Complex: Treatments - effects on rate groups

## Only treatments

```{r c_trt_m1}
complex_rate_data <- rbind(
  tibble(.from = paste0(c("Oxygen", "Ventilated"), "_worsening"), .to = "Death", rate_group = "death"),
  tibble(.from = "AA_improving", 
         .to = "Discharged", 
         rate_group = "improve_one"),
  tibble(.from = paste0(breathing_s_levels[2 : length(breathing_s_levels)], "_improving"), 
         .to = paste0(breathing_s_levels[1 : (length(breathing_s_levels) - 1)] , "_improving"), 
         rate_group = "improve_one"),
  tibble(.from = paste0(breathing_s_levels[1 : (length(breathing_s_levels) - 1)], "_worsening"),
         .to = paste0(breathing_s_levels[2 : length(breathing_s_levels)], "_worsening"),
         rate_group = "worsen_one"),
  tibble(.from = paste0(breathing_s_levels, "_worsening"),
         .to = paste0(breathing_s_levels, "_improving"),
         rate_group = "to_improving"),
  tibble(.from = paste0(breathing_s_levels, "_improving"),
         .to = paste0(breathing_s_levels, "_worsening"),
         rate_group = "to_worsening")
) %>%
  mutate(.rate_id = factor(paste0(.from, "_", .to), levels = paste0(.from, "_", .to)),
  ) %>%
  mutate(rate_group = fct_relevel(rate_group, "improve_one"))

complex_hidden_state_data <- rbind(
  tibble(base = breathing_s_levels) %>% mutate(corresponding_obs = base) %>% 
    crossing(tibble(state_group = c("_improving", "_worsening"))) %>% 
    mutate(id = factor(paste0(base, state_group))) %>%
    select(-base, -state_group),
  tibble(id = c("Death","Discharged")) %>% mutate(corresponding_obs = id)
)


complex_initial_states <- serie_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed) %>% paste0(., "_worsening")

c_trt_m1 <- brmshmmdata(trt_group_m1_formula, serie_data, 
                  complex_rate_data, complex_hidden_state_data, complex_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)

c_trt_m1_fit <- brmhmm(c_trt_m1, cache_file = paste0(cache_dir,"/c_trt_m1.rds"), control = default_control, init = 0.1, iter = 1500)

summary(c_trt_m1_fit$brmsfit)


```

```{r}
hmm_hypothesis_res_list[["c_trt_rate_m1"]] <- evaluate_all_treatment_hypotheses(c_trt_m1_fit, model_subgroup = "complex_group", adjusted ="all treatments, supportive", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)
```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(c_trt_m1_fit)
}
```

## Treatments + age + sex


```{r c_trt_m2}
c_trt_m2 <- brmshmmdata(trt_group_m2_formula, serie_data, 
                  complex_rate_data, complex_hidden_state_data, complex_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)


c_trt_m2_fit <- brmhmm(c_trt_m2, cache_file = paste0(cache_dir,"/c_trt_m2.rds"), init = 0.1, control = default_control, iter = 1200)

#parnames(c_trt_m2_fit$brmsfit)
summary(c_trt_m2_fit$brmsfit)
```


```{r}
hmm_hypothesis_res_list[["c_trt_rate_m2"]] <- evaluate_all_treatment_hypotheses(c_trt_m2_fit, model_subgroup = "complex_group", adjusted ="all treatments, supportive, age, sex", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)

```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(c_trt_m2_fit)
}
```


## Treatments + age + sex + hospital

```{r c_trt_m3}
c_trt_m3 <- brmshmmdata(trt_group_m3_formula, serie_data, 
                  complex_rate_data, complex_hidden_state_data, complex_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)

c_trt_m3_fit <- brmhmm(c_trt_m3, cache_file = paste0(cache_dir,"/c_trt_m3.rds"), init = 0.1, control = default_control, iter = 1200)

summary(c_trt_m3_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["c_trt_rate_m3"]] <- evaluate_all_treatment_hypotheses(c_trt_m3_fit, model_subgroup = "complex_group", adjusted ="all treatments, supportive, age, sex, hospital", model_check = "OK", cl = cl, serie_data_28 = serie_data_28)

```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(c_trt_m3_fit)
}
```

## Treatments + age + sex + hospital, first wave

```{r c_trt_m3_fw}
complex_initial_states_fw <- serie_data_fw %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed) %>% paste0(., "_worsening")

c_trt_m3_fw <- brmshmmdata(trt_group_m3_formula, serie_data_fw, 
                  complex_rate_data, complex_hidden_state_data, complex_initial_states_fw, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)

c_trt_m3_fw_fit <- brmhmm(c_trt_m3_fw, cache_file = paste0(cache_dir,"/c_trt_m3_fw.rds"), init = 0.1, control = default_control, iter = 1200)

summary(c_trt_m3_fw_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["c_trt_rate_m3_fw"]] <- evaluate_all_treatment_hypotheses(c_trt_m3_fw_fit, model_subgroup = "complex_group", adjusted ="all treatments, supportive, age, sex, hospital, first_wave", model_check = "OK", cl = cl, serie_data_28 = serie_data_28_fw)

```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(c_trt_m3_fit)
}
```


## Treatment + age + sex + hospital + comorbidities


```{r c_trt_m4}
c_trt_m4 <- brmshmmdata(trt_group_m4_formula, serie_data, 
                  complex_rate_data, complex_hidden_state_data, complex_initial_states, prior = trt_group_m1_prior,
                  observed_state_data = base_observed_state_data)


c_trt_m4_fit <- brmhmm(c_trt_m4, cache_file = paste0(cache_dir,"/c_trt_m4.rds"), init = 0.1, control = default_control, iter = 1200)

summary(c_trt_m4_fit$brmsfit)
```

```{r}
hmm_hypothesis_res_list[["c_trt_rate_m4"]] <- evaluate_all_treatment_hypotheses(c_trt_m4_fit, model_subgroup = "complex_group", adjusted ="all treatments, supportive, age, sex, hospital, comorbidities", model_check = "Suspicious", cl = cl, serie_data_28 = serie_data_28)

```


```{r}
if(do_pp_checks) {
  do_common_pp_checks(c_trt_m4_fit)
}
```


# Environment


```{r}
hmm_hypothesis_res_all <- do.call(rbind, hmm_hypothesis_res_list)
write_csv(hmm_hypothesis_res_all, path = here::here("manuscript", "hmm_res.csv"))
```

```{r}
sessionInfo()
```

