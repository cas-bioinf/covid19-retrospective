---
title: "HMM Model"
output: html_document
---

```{r}
devtools::load_all()
library(tidyverse)
options(mc.cores = parallel::detectCores())
rstan::rstan_options(auto_write = TRUE)

theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()
wide <- data$marker_data_wide

cache_dir <- here::here("local_temp_data")
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

#Temporary hack
registerS3method("stan_llh", class = "rate_hmm", method = stan_llh.rate_hmm, envir = asNamespace("brms"))
```

```{r}
series_data <- wide %>%
  inner_join(data$patient_data, by = c("hospital_id", "patient_id")) %>% 
  mutate(.time = day, .serie = patient_id, .observed = breathing) %>%
  mutate(.time = .time +1) %>% 
  filter(.time >= 1) %>%
  group_by(.serie) %>%
  filter(sum(!is.na(.observed)) > 1) %>%
  ungroup()


```

```{r}
data$patient_data %>% filter(!is.na(best_supportive_care_from)) %>% select(outcome)
```


```{r}
hcq_m1_hidden_state_data <- tibble(id = factor(disease_levels, levels = disease_levels)) %>% mutate( corresponding_obs = id)

hcq_m1_observed_state_data <- tibble(id = factor(disease_levels, levels = disease_levels), is_noisy = FALSE)

recode_group <- function(rate_data, group_name) {
  is_column <- paste0("is_", group_name) 
  id_column <- paste0(group_name, "_id") 
  
  rate_data %>% mutate(
    !!is_column := as.double(rate_group == group_name),
    !!id_column := factor(
      if_else(rate_group == group_name, as.integer(.rate_id) - min(as.integer(.rate_id[rate_group == group_name])), as.integer(0)), 
      levels = 0:(sum(rate_group == group_name) - 1), 
      ordered = TRUE)
  )
}

hcq_m1_rate_data <- rbind(
  tibble(.from = breathing_levels, .to = "Death", rate_group = "death"),
  tibble(.from = "AA", .to = "Discharged", rate_group = "improve_one"),
  tibble(.from = breathing_levels[2 : length(breathing_levels)], .to = breathing_levels[1 : (length(breathing_levels) - 1)], rate_group = "improve_one"),
  tibble(.from = breathing_levels[1 : (length(breathing_levels) - 1)], .to = breathing_levels[2 : length(breathing_levels)], rate_group = "worsen_one")
) %>%
  mutate(.rate_id = factor(1:n()),
         .from = factor(.from, levels = disease_levels),
         .to = factor(.to, levels = disease_levels)
  ) %>%
  recode_group("death") %>%
  recode_group("improve_one") %>%
  recode_group("worsen_one")

hcq_m1_initial_states <- series_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)

hcq_m1_prior = brms::set_prior("normal(-2, 5)", "Intercept") +
  brms::set_prior("normal(0, 5)", "b") +
  brms::set_prior("normal(0, 2)", "sd")

hcq_m1_formula <- ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + took_hcq * rate_group
hcq_m1 <- brmshmmdata(hcq_m1_formula, series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m1_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

#make_stancode_hmm(hcq_m1)
#xx <- brms::make_standata(hcq_m1$formula, data = make_data_hmm(hcq_m1)$brmsdata)
hcq_m1_fit <- brmhmm(hcq_m1, cache_file = paste0(cache_dir,"/hcq_m1.rds"))

summary(hcq_m1_fit$brmsfit)
  
```
```{r}
hcq_m1_epred_rect <- posterior_epred_rect(hcq_m1_fit)
hcq_m1_predicted_rect <- posterior_epred_to_predicted(hcq_m1_fit, hcq_m1_epred_rect)
hcq_m1_predicted <- posterior_rect_to_long(hcq_m1_fit, hcq_m1_predicted_rect)
```



```{r}
hcq_m1_predicted_df <- posterior_long_to_df(hcq_m1_fit$data, hcq_m1_predicted)

all_ids <- hcq_m1_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m1_predicted_df, all_ids[series_id], hcq_m1_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m1_fit, hcq_m1_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m1_fit, hcq_m1_predicted_rect)
pp_check_transitions_direction(hcq_m1_fit, hcq_m1_predicted_rect, states_from = 2:6)
```

```{r}
hcq_m2_formula <- ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + took_hcq * rate_group + age_norm * rate_group + sex * rate_group
hcq_m2 <- brmshmmdata(hcq_m2_formula, series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m1_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m2_fit <- brmhmm(hcq_m2, cache_file = paste0(cache_dir,"/hcq_m2.rds"))

summary(hcq_m2_fit$brmsfit)
```


```{r}
hcq_m2_epred_rect <- posterior_epred_rect(hcq_m2_fit)
hcq_m2_predicted_rect <- posterior_epred_to_predicted(hcq_m2_fit, hcq_m2_epred_rect)
hcq_m2_predicted <- posterior_rect_to_long(hcq_m2_fit, hcq_m2_predicted_rect)
```



```{r}
hcq_m2_predicted_df <- posterior_long_to_df(hcq_m2_fit$data, hcq_m2_predicted)

all_ids <- hcq_m2_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m2_predicted_df, all_ids[series_id], hcq_m2_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m2_fit, hcq_m2_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m2_fit, hcq_m2_predicted_rect)
pp_check_transitions_direction(hcq_m2_fit, hcq_m2_predicted_rect, states_from = 2:6)
```

```{r}
hcq_m3_formula <- ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + took_hcq * rate_group + age_norm * rate_group + sex * rate_group + (rate_group | hospital_id)
hcq_m3 <- brmshmmdata(hcq_m3_formula, series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m1_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m3_fit <- brmhmm(hcq_m3, cache_file = paste0(cache_dir,"/hcq_m3.rds"))

summary(hcq_m3_fit$brmsfit)
```
```{r}
hcq_m3_epred_rect <- posterior_epred_rect(hcq_m3_fit)
hcq_m3_predicted_rect <- posterior_epred_to_predicted(hcq_m3_fit, hcq_m3_epred_rect)
hcq_m3_predicted <- posterior_rect_to_long(hcq_m3_fit, hcq_m3_predicted_rect)
```



```{r}
hcq_m3_predicted_df <- posterior_long_to_df(hcq_m3_fit$data, hcq_m3_predicted)

all_ids <- hcq_m3_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m3_predicted_df, all_ids[series_id], hcq_m3_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m3_fit, hcq_m3_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m3_fit, hcq_m3_predicted_rect)
pp_check_transitions_direction(hcq_m3_fit, hcq_m3_predicted_rect, states_from = 2:6)
```


```{r}
hcq_m4_formula <- ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + took_hcq * rate_group + took_az * rate_group + age_norm * rate_group + sex * rate_group + (rate_group | hospital_id)
hcq_m4 <- brmshmmdata(hcq_m4_formula, series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m1_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m4_fit <- brmhmm(hcq_m4, cache_file = paste0(cache_dir,"/hcq_m4.rds"))

summary(hcq_m4_fit$brmsfit)
```

```{r}
hcq_m4_epred_rect <- posterior_epred_rect(hcq_m4_fit)
hcq_m4_predicted_rect <- posterior_epred_to_predicted(hcq_m4_fit, hcq_m4_epred_rect)
hcq_m4_predicted <- posterior_rect_to_long(hcq_m4_fit, hcq_m4_predicted_rect)
```



```{r}
hcq_m4_predicted_df <- posterior_long_to_df(hcq_m4_fit$data, hcq_m4_predicted)

all_ids <- hcq_m4_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m4_predicted_df, all_ids[series_id], hcq_m4_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m4_fit, hcq_m4_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m4_fit, hcq_m4_predicted_rect)
pp_check_transitions_direction(hcq_m4_fit, hcq_m4_predicted_rect, states_from = 2:6)
```


## hcq_m5 - 


```{r}
hcq_m5_formula <-  ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + took_hcq * rate_group + age_norm * rate_group + sex * rate_group + (rate_group | hospital_id) + mo(comorbidities_sum) * rate_group
hcq_m5 <- brmshmmdata(hcq_m5_formula, series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m1_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m5_fit <- brmhmm(hcq_m5, cache_file = paste0(cache_dir,"/hcq_m5.rds"))

summary(hcq_m5_fit$brmsfit)
```

```{r}
hcq_m5_epred_rect <- posterior_epred_rect(hcq_m5_fit)
hcq_m5_predicted_rect <- posterior_epred_to_predicted(hcq_m5_fit, hcq_m5_epred_rect)
hcq_m5_predicted <- posterior_rect_to_long(hcq_m5_fit, hcq_m5_predicted_rect)
```



```{r}
hcq_m5_predicted_df <- posterior_long_to_df(hcq_m5_fit$data, hcq_m5_predicted)

all_ids <- hcq_m5_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m5_predicted_df, all_ids[series_id], hcq_m5_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m5_fit, hcq_m5_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m5_fit, hcq_m5_predicted_rect)
pp_check_transitions_direction(hcq_m5_fit, hcq_m5_predicted_rect, states_from = 2:6)
```

## hcq_m6 - D-dimer


```{r}
hcq_m6_series_data <- series_data %>% 
  group_by(.serie) %>%
  filter(any(!is.na(d_dimer))) %>%
  ungroup() %>%
  compute_marker_peak(column_name = "d_dimer", new_column_name = "peak_d_dimer", initial_value = 0) %>%
  mutate(log_peak_d_dimer = log(peak_d_dimer + 1) - 4)

hcq_m6_initial_states <- hcq_m6_series_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)


hcq_m6_formula <-  ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + age_norm * rate_group + sex * rate_group + (rate_group | hospital_id) + log_peak_d_dimer * rate_group


hcq_m6 <- brmshmmdata(hcq_m6_formula, hcq_m6_series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m6_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m6_fit <- brmhmm(hcq_m6, cache_file = paste0(cache_dir,"/hcq_m6.rds"))

summary(hcq_m6_fit$brmsfit)
```

```{r}
hcq_m6_epred_rect <- posterior_epred_rect(hcq_m6_fit)
hcq_m6_predicted_rect <- posterior_epred_to_predicted(hcq_m6_fit, hcq_m6_epred_rect)
hcq_m6_predicted <- posterior_rect_to_long(hcq_m6_fit, hcq_m6_predicted_rect)
```



```{r}
hcq_m6_predicted_df <- posterior_long_to_df(hcq_m6_fit$data, hcq_m6_predicted)

all_ids <- hcq_m6_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m6_predicted_df, all_ids[series_id], hcq_m6_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m6_fit, hcq_m6_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m6_fit, hcq_m6_predicted_rect)
pp_check_transitions_direction(hcq_m6_fit, hcq_m6_predicted_rect, states_from = 2:6)
```

## hcq_m7 - IL-6


```{r}
hcq_m7_series_data <- series_data %>% 
  group_by(.serie) %>%
  filter(any(!is.na(IL_6))) %>%
  ungroup() %>%
  compute_marker_peak(column_name = "IL_6", new_column_name = "peak_IL_6", initial_value = 1) %>%
  mutate(log_peak_IL_6 = log(peak_IL_6))

hcq_m7_initial_states <- hcq_m7_series_data %>% filter(.time == 1) %>% arrange(.serie) %>% pull(.observed)


hcq_m7_formula <-  ~ is_improve_one + is_death + mo(death_id) + (0 + is_worsen_one | worsen_one_id) + 
    (0 + is_improve_one | improve_one_id) + best_supportive_care * rate_group + age_norm * rate_group + sex * rate_group + (rate_group | hospital_id) + log_peak_IL_6 * rate_group


hcq_m7 <- brmshmmdata(hcq_m7_formula, hcq_m7_series_data, 
                  hcq_m1_rate_data, hcq_m1_hidden_state_data, hcq_m7_initial_states, prior = hcq_m1_prior,
                  observed_state_data = hcq_m1_observed_state_data)

hcq_m7_fit <- brmhmm(hcq_m7, cache_file = paste0(cache_dir,"/hcq_m7.rds"))

summary(hcq_m7_fit$brmsfit)
```

```{r}
hcq_m7_epred_rect <- posterior_epred_rect(hcq_m7_fit)
hcq_m7_predicted_rect <- posterior_epred_to_predicted(hcq_m7_fit, hcq_m7_epred_rect)
hcq_m7_predicted <- posterior_rect_to_long(hcq_m7_fit, hcq_m7_predicted_rect)
```



```{r}
hcq_m7_predicted_df <- posterior_long_to_df(hcq_m7_fit$data, hcq_m7_predicted)

all_ids <- hcq_m7_fit$data$serie_data %>% select(hospital_id, .serie) %>% 
  distinct() %>% arrange(hospital_id) %>% pull(.serie)
step_size <- 6
for(step in 1:ceiling(length(all_ids) / step_size)) {
  series_id <- ((step - 1) * step_size + 1) : (step* step_size)
  
  posterior_state_plot(hcq_m7_predicted_df, all_ids[series_id], hcq_m7_fit$data) %>% print()

}
```

```{r}
pp_check_last_state(hcq_m7_fit, hcq_m7_predicted_rect) #TODO separately terminal and non-terminal states. Or "state at time t" - this should be coherent
pp_check_transitions_direction(hcq_m7_fit, hcq_m7_predicted_rect)
pp_check_transitions_direction(hcq_m7_fit, hcq_m7_predicted_rect, states_from = 2:6)
```
