---
title: "Detailed disease progression of 213 patients hospitalized with Covid-19 in the Czech Republic: An exploratory analysis" 
output: 
  #rticles::arxiv_article
  #pdf_document
  # bookdown::pdf_document2:
  #    toc: false
  bookdown::word_document2: 
    toc: false
    number_sections: false
    reference_docx: "output_template.docx"
abstract: |  
  **Abstract:** We collected a multi-centric retrospective dataset of patients who were admitted to 10 hospitals in Czech Republic and tested positive for SARS-CoV-2. The dataset contains baseline patient characteristics, breathing support required, pharmacological treatment received and multiple markers on daily resolution. Patients in the dataset were treated with hydroxychloroquine (N = 108), azithromycin (N = 72), favipiravir (N = 9), convalescent plasma (N = 7), dexamethasone (N = 4) and remdesivir (N = 3), often in combination. Most patients were admitted during the first wave of the epidemic. To explore association between treatments and patient outcomes we performed multiverse analysis, observing how the conclusions change between defensible choices of statistical model, predictors included in the model and other analytical degrees of freedom.  Weak evidence to constrain the potential efficacy of azithromycin and favipiravir can be extracted from the data. Additionally, we performed external validation of several proposed prognostic models for Covid-19 severity showing that they mostly perform unsatisfactorily on our dataset.
bibliography: Covid19.json
csl: journal-of-medical-virology.csl
date: "Version: `r format(Sys.time(), '%Y-%m-%d')`"
author: "`r { source(here::here('manuscript', 'authors.R')); get_authors_string() }`"
---

```{r setup, echo=FALSE, message=FALSE, warning = FALSE, results = "hide"}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8)

devtools::load_all()
library(tidyverse)
library(patchwork)
library(tsiMisc) # devtools::install_github("tsieger/tsiMisc")
theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()
wide <- data$marker_data_wide

n_patients <- nrow(data$patient_data)
n_hospitals <- length(unique(data$patient_data$hospital_id))
```

# Introduction 

The Covid-19 pandemic, caused by severe acute respiratory syndrome coronavirus (SARS-CoV-2) has, as of November 2020, led to over 46 million cases and over 1.1 million deaths. Proposed treatments include antivirals approved for other indications (chloroquine, hydroxychloroquine, lopinavir/ritonavir, remdesivir, favipiravir, umifenovir), azithromycin, corticosteroids, immunoglobulins, tocilizumab and convalescent plasma [@http://zotero.org/users/5567156/items/8XWTUMUI; @http://zotero.org/users/5567156/items/6Q8Z8VJR]. As of this writing, the only treatment that exhibited positive effects in randomized trials is the corticosteroid dexamethasone for severe cases [@http://zotero.org/users/5567156/items/IW6VZ53Q; @http://zotero.org/users/5567156/items/5VAKEW58]. Remdesivir, previously designed and approved for Ebola, SARS and MERS, is currently the only antiviral against SARS-CoV-2 approved by the FDA. However, during spring and summer it was available only in limited amounts via compassionate use programme. Randomized clinical trials on remdesivir have provided  conflicting evidence [@http://zotero.org/users/5567156/items/MFS3IPPU; @http://zotero.org/users/5567156/items/KB5UDZH3]. Despite initial promise, hydroxychloroquine has failed to show benefit for both hospitalized patients [@http://zotero.org/users/5567156/items/9X3UH8ZM; @http://zotero.org/users/5567156/items/KB5UDZH3], as an early treatment [@http://zotero.org/users/5567156/items/G6KZKVMI], as well as pre- and post-exposure prophylaxis [@http://zotero.org/users/5567156/items/7C23YCV5; @http://zotero.org/users/5567156/items/GMR9FX9Z; @http://zotero.org/users/5567156/items/H4CLJNUR]. Further, no improvement could be discerned when adding azithromycin to hydroxychloroquine therapy [@http://zotero.org/users/5567156/items/BQLRZGTQ]. Similarly, Lopinavir/Ritonavir did not show benefit [@http://zotero.org/users/5567156/items/6I6GAVWU]. No benefit was observed for convalescent plasma [@http://zotero.org/users/5567156/items/UEXLDJCB; @http://zotero.org/users/5567156/items/BHGT88US]. 

Interestingly, in observational studies, hydroxychloroquine was often found to be associated with better outcomes [e. g., @http://zotero.org/users/5567156/items/WZPNBRYN; @http://zotero.org/users/5567156/items/4HR7MUJ6; @http://zotero.org/users/5567156/items/NXC9CDI9].


Favipiravir is one of the less explored experimental treatments, previously used for influenza including avian types, with only one larger RCT in Covid- 19 known to us [@http://zotero.org/users/5567156/items/ISLSL7UC], the study however has many potentially severe problems [@http://zotero.org/users/5567156/items/7HDXLWEA]. Even considering studies or case series with only several treated patients, very few are available [@http://zotero.org/users/5567156/items/F3VNTQ92; @http://zotero.org/users/5567156/items/FSUQMUP8; @http://zotero.org/users/5567156/items/894H9N9B]. None of the results allow strong conclusions about benefits or harms of favipiravir, although a  metaanalysis of all available small studies showed an effect of favipiravir on clinical improvement in mild and moderate disease [@http://zotero.org/users/5567156/items/7595KBWR].

 For additional summary of treatments under investigation see [@http://zotero.org/users/5567156/items/YP62P6XJ].


High IL-6, D-dimer values were observed to be associated with worse outcome and increased disease severity [@http://zotero.org/users/5567156/items/K3N3VG2X].
Large study of electronic health records [@http://zotero.org/users/5567156/items/ARTB8HYZ] showed an increase in C-reactive protein in early disease and increase of D-dimer and white blood cell count in later stages of the disease.

An ongoing challenge in evaluating Covid-19 treatments is that the analysis and interpretation of the data is often inappropriate or misleading, most notably interpreting lack of evidence due to small sample size as evidence of no effect [see e.g., @http://zotero.org/users/5567156/items/5PZEEPJV; @http://zotero.org/users/5567156/items/AZDZHLJV].

Additionally, many methods for predicting disease severity of Covid-19 were published, but the methods are at high risk of bias and lack external validation [@http://zotero.org/users/5567156/items/TS57HJ3T].

The present study aims to describe the outcomes and disease course of hospitalized patients with mild to severe clinical presentation in a multicentric Czech cohort, explore the association between the outcomes and pharmacological interventions and to provide external validation to previously published prognostic models for Covid-19 severity.

# Patients and Methods


## Data Collection

```{r}
ethics_data <- readxl::read_excel(here::here("manuscript", "ethics.xlsx"), sheet = "Sheet1", na = "NA")
ethics_string <- ethics_data %>% pull(Site) %>% paste0(collapse = ", ")

n_ecmo <- data$marker_data_wide %>% filter(breathing == "ECMO") %>% pull(patient_id) %>% unique() %>% length()
n_nippv <- data$marker_data_wide %>% filter(breathing == "NIPPV") %>% pull(patient_id) %>% unique() %>% length()

n_second_wave <- data$patient_data %>% filter(!first_wave) %>% nrow()
```


A convenience sample of patients from `r n_hospitals` sites was collected. For each site, the dataset contains all patients hospitalized in the participating wards over the data collection period. The data collection started at the onset of the Covid-19 pandemic (except for one site where some older records were inaccessible), but the end date for collection differs between sites due to time constraints of the participating physicians. Three sites included total of `r n_second_wave` patients that could be considered part of "second wave", i.e. admitted after September 1st, last patient included in the dataset was admitted on October 12th. See Supplementary Figure 1 for per-site data collection periods. Patients over the age of 18 were included if they had PCR-confirmed infection of SARS-CoV-2 and were not participating in a clinical trial of any Covid-19 pharmacotherapy. 

We collected data on comorbidities and information about disease progression on daily resolution including breathing support required, oxygen flow, experimental anti-Covid-19 and antimicrobial drugs taken and several laboratory markers (PCR positivity for SARS-CoV-2, C-reactive protein, D-dimer, Interleukin 6, Ferritin, lymphocyte count). Full protocol for data collection is attached in the supplementary material. Due to very low number of patients using extra-corporeal membrane oxygenation (N = `r n_ecmo`) or non-invasive positive pressure ventilation (N = `r n_nippv`) in our sample, we merged those categories with mechanical ventilation.

Not all patients developed pneumonia or other symptoms of Covid-19. All patients received the standard of care including supplemental oxygen and ventilation and antibiotics for bacterial superinfections as determined by the attending physician. Some patients were not indicated for all treatment modalities (especially mechanical ventilation) based on decision of the attending physician and underlying patient condition. We note that the participating sites were not homogeneous in either patient population or treatment protocols. The choice of pharmacological treatment was based on the decision of the attending clinician and its availability.

The study was approved by the Ethical committees of `r ethics_string`.

## Statistical analysis

The character of the convenience sample does not allow for a proper assessment of
the association between treatments and patient outcomes,
because the treatments had not been assigned to patients at random, 
but were only observed retrospectively. This can be partially remedied by adjusting for patient characteristics in the analysis, but such adjustments will always be imperfect and the analysis  needs to be treated as exploratory and interpreted cautiously.

Since many details of analysis may influence the conclusions made, we performed multiverse analysis [@http://zotero.org/users/5567156/items/DXWM259V] and report results for all the hypothesis tested across multiple different models using both frequentist and Bayesian paradigms. For each model class we worked with several possible sets of adjustments. All analyses were performed in the R language [@http://zotero.org/users/5567156/items/67XKBC2W], visualizations and data cleaning was run with the `tidyverse` package [@http://zotero.org/users/5567156/items/8EWY8TKM]. 

```{r}
 # and - where applicable - with multiple estimands of the outcome as different tasks require different estimands [@http://zotero.org/users/5567156/items/MH797GNC]
```

First class of models are frequentist survival and multistate models under the proportional hazards assumption as implemented in the `coxph` function from the `survival` package [@http://zotero.org/users/5567156/items/I9UVTUJF]. We primarily use a model with competing risks for death and discharge from hospital (see Figure&nbsp;\@ref(fig:modelstates)a).

Second class of models are Bayesian hidden Markov models (HMM) of disease progression implemented via a custom extension to the `brms` package [@http://zotero.org/users/5567156/items/7ER3ZSER]. The parametrization of the HMM is inspired by Williams et al.[@http://zotero.org/users/5567156/items/F9K2L5Q8]: the actual process of disease is assumed to be continuous and allow only for transitions between neighboring states (as shown in Figure&nbsp;\@ref(fig:modelstates)b, c). The total probability of transition between any two states over the period of a day is then computed as the total probability of transition across all possible paths. This class of models does not satisfy the proportional hazards assumption, instead, it is assumed the process has the Markov property - i.e. that the (potentially unobserved) state and the covariates at a given day contain all the information to determine probabilities of the states on the next day. We use two versions of such models, one working solely with the observed breathing support and one assuming a hidden improving/worsening distinction. All of the hidden Markov models take into account whether best supportive care was initiated and a patient was thus not indicated to progress to more intensive treatment modalities.


```{r modelstates, fig.cap="States used in the competing risk model (a) and in the two hidden Markov model variants (b,c). AA = Ambient air, Oxygen = Nasal oxygen, Ventilated = any form of ventilation (non-invasive positive-pressure ventilation, mechanical ventilation and extra-corporeal membrane oxygenation). In all models the 'Death' and 'Discharged' states are terminal. In the second hidden Markov model (c), the 'Improving' and 'Worsening' variants of each non-terminal state are not observable - only the breathing support is observed and improving/worsening is inferred from progression of the disease." }
knitr::include_graphics(here::here("manuscript","static_figs","model_states.png"), auto_pdf = TRUE)
```

<!-- When markers are used as predictors in both the hidden Markov models and the competing risks model, we impute the missing values using either the maximum of the marker so far or the last-known value of the marker.   -->

<!-- Additionally we used joint models for longitudinal and time-to-event data via the `stan_jm` function in the `rstanarm` package [@http://zotero.org/users/5567156/items/KHJGLQS5]. Those models include a longitudinal component to model the evolution over time of marker for each patient and a time-to-event component which assumes proportional-hazards for an event. The estimated value of the marker is then used as one of the predictors in the time-to-event component.  -->

Finally we used a set of Bayesian regression models implemented with the `brms` package [@http://zotero.org/users/5567156/items/7ER3ZSER]. Those included overall survival, state at day 7 or 28 as either binary or categorical outcome and a Bayesian version of the Cox proportional-hazards model.

```{r}
#Since `stan_jm` does not support competing risks, we imputed the second event...
```

Except for age, sex and comorbidities, all covariates are treated as time-varying, e.g., the effect of taking a drug is only included for the days after the drug was taken. More details on the exact model formulations can be found in the supplementary statistical analysis.

```{r}
#Sex differences are to be expected for both sociological and biological [@http://zotero.org/users/5567156/items/5KQZ3XEE] reasons.
```

## Evaluating prognostic models

We searched the living systematic review of Covid-19 prognostic models [@http://zotero.org/users/5567156/items/TS57HJ3T] for those that could be applied to our dataset (i.e. where we have gathered all the input features).  We primarily focused on the Area Under Receiver Operating Characteristic Curve (AUC), and its bootstrapped 95% confidence intervals which we computed using the `pROC` package [@http://zotero.org/users/5567156/items/UN6BIC67]. When there were multiple reasonable ways to evaluate the outcome or a predictor in our dataset, we computed and reported all of those options. We used two simple scores with age or the decade of age as the sole predictor to have a baseline to compare the scores against.

Complete code for all analyses is available at https://github.com/cas-bioinf/covid19retrospective/.

# Results


In total, we were able to gather data for `r n_patients` patients, see Table \@ref(tab:summarytable) for the overall characteristics of the patient sample and several subgroups we used in the analysis, including treatments taken. 
The exact treatment combinations are shown in Supplementary Table TODO1.
Supplementary Table TODO2 gives overview of outcomes at different hospitals, demonstrating quite large hospital-specific differences, insinuating that further analyses should stratify on hospitals.
The dataset includes 19 patients already reported in a study of inflammatory signatures of Covid-19 [@http://zotero.org/users/5567156/items/IA4FQCF3]. 


```{r summarytable, echo=FALSE}

data_table_1 <- rbind(
  data$patient_data %>% mutate(group = "All"),
  data$patient_data %>% mutate(group = if_else(ever_hcq, "HCQ", "No HCQ")),
  data$patient_data %>% filter(ever_favipiravir) %>% mutate(group = "Favipiravir")
  # data$patient_data %>% filter(any_d_dimer) %>% mutate(group = "Measured D-dimer"),
  # data$patient_data %>% filter(any_IL_6) %>% mutate(group = "Measured IL-6")
  )


data_table_1 %>% group_by(group) %>% 
  summarise(
    N = n(),
    `Distinct sites` = length(unique(hospital_id)),
    Male = sum_percent(sex == "M"),
    `Age (mean, IQR)` = mean_iqr(age),
    `Admitted for Covid` = sum_percent(admitted_for_covid),
    `Took azithromycin` = sum_percent(ever_az),
    `Took dexamethasone` = sum_percent(ever_dexamethasone),
    `Took favipiravir` = sum_percent(ever_favipiravir),
    `Took remdesivir` = sum_percent(ever_remdesivir),
    `Convalescent plasma` = sum_percent(ever_convalescent_plasma),
    `Ischemic Heart Disease` = sum_percent(ischemic_heart_disease),
    `Takes antihypertensives` = sum_percent(has_hypertension_drugs),	
    `Heart Failure` = sum_percent(heart_failure),
    COPD = sum_percent(COPD),
    Asthma = sum_percent(asthma),
    `Other lung disease` = sum_percent(other_lung_disease),
    Diabetes = sum_percent(diabetes),
    `Renal Disease` = sum_percent(renal_disease),
    `Liver Disease` = sum_percent(liver_disease),
    `Smoking` = sum_percent(smoking),
    `BMI (mean, IQR)` = mean_iqr(BMI),
    `Best supportive care` = sum_percent(!is.na(best_supportive_care_from)),
    Deceased = sum_percent(outcome == "Death"),
    Discharged = sum_percent(outcome == "Discharged"),
    .groups = "drop"
  ) %>%
  mutate(group = factor(group, levels= c("All", "HCQ", "No HCQ", "Favipiravir"), ordered = TRUE)) %>%
  arrange(group) %>%
  as.data.frame() %>%
  column_to_rownames("group") %>%
  t() %>% 
  knitr::kable(caption = "Patient characteristics for the overall sample and treatment subgroups. Note that the favipiravir subgroup is not exclusive with either the HCQ or No HCQ group. IQR = interquartile range, COPD = Chronic obstructive pulmonary disease, BMI = body-mass index, Best supportive care = patient was not indicated to undergo more intensive treatment modality.", booktabs = TRUE)

# Note that the 'Measured D-dimer' and 'Measured IL-6' are neither exclusive nor exhaustive.
```

```{r treatment_comb_table, echo=FALSE}
# Table \@ref(tab:treatment_comb_table} gives overview of combinations of treatments used in individual patients.
# Currently not showing - almost all of this information is visible in the table above. Will put in supplement
#pd<-data$patient_data
# x<-sort(table(paste0(
#   as.numeric(pd$ever_hcq),
#   as.numeric(pd$ever_az),
#   as.numeric(pd$ever_convalescent_plasma),
#   as.numeric(pd$ever_favipiravir),
#   as.numeric(pd$ever_remdesivir),
#   as.numeric(pd$ever_dexamethasone),
#   as.numeric(pd$ever_antibiotics))),dec=TRUE)
# x2<-c()
# nms<-c('HCQ','AZ','Plasma','Favipiravir','Remdesivir','Dexamethasone','ATB')
# for (i in 1:length(x)) {
#   x3<-c()
#   for (i2 in 1:nchar(names(x)[i])) {
#     x3<-c(x3,ifelse(substring(names(x)[i],i2,i2)=='1',nms[i2],''))
#   }
#   x2<-rbind(x2,cbind(n=x[i],rbind(x3)))
# }
# rownames(x2)<-c()
# colnames(x2)<-c('N',nms)
# x2<-x2[,c(1,2,3,8,4:7)]
# knitr::kable(x2,caption = "Treatment combinations in individual patients.", booktabs = TRUE)
```

In Figure&nbsp;\@ref(fig:progression) we show the overall disease progression for all patients and in Figure&nbsp;\@ref(fig:selectedmarkers) we show the time-course of a subset of the markers we have measured. The data show some interesting patterns: patients with low Interleukin-6 or D-dimer values are overrepresented among patients with better outcomes, most patients had high CRP upon admission and for many the CRP levels stayed elevated over the whole hospitalization. However, the limited nature of the data does not allow for any statistically robust conclusions. We also see that the marker levels were not substantially stratified by study site.  Those patterns should however be interpreted with care due to systematic missingness of the data - in particular, patients that fared worse were probably more likely to have the markers measured. However we believe this kind of patient-level view is useful to appreciate the extent of both between-patient and within-patient variability.

```{r progression, fig.cap="Disease progression for all patients included in the study as determined by breathing support required. Ventilated = any form of ventilation (non-invasive positive-pressure ventilation, mechanical ventilation and extra-corporeal membrane oxygenation)."}
my_paste <- function(x) {
  paste0(as.integer(x), collapse = "")
}



data_for_fig_progression <- wide  %>% 
  filter(!is.na(breathing_s), day >= 0) %>%
  arrange(hospital_id, patient_id, day) %>%
  mutate(patient_id = factor(patient_id), patient_id = fct_reorder(patient_id, breathing_s,  .fun = my_paste, .desc = FALSE)) %>%
  mutate(first_half = as.integer(patient_id) < length(levels(patient_id)) / 2 + 1, 
         is_outcome =  breathing_s %in% c("Discharged", "Death"),
         breathing_s = fct_recode(breathing_s, `Ambient air` = "AA")
         ) 

fig_progression <- data_for_fig_progression %>% 
  filter(!is_outcome) %>%
  ggplot(aes(x = day, y = patient_id, fill = breathing_s)) + 
  geom_tile(height = 0.7) + 
  geom_point(data = data_for_fig_progression %>% filter(is_outcome) %>% mutate(outcome = factor(breathing_s, ordered = FALSE)),
             inherit.aes = FALSE, aes(x = day, y = patient_id, shape = outcome), size = 0.9) +
  scale_fill_viridis_d("", direction = -1) +
  scale_x_continuous("Days since hospitalization") +
  scale_shape_manual("", values = c(1, 15), guide = guide_legend(override.aes = list(size = 4))) +
  facet_wrap(~first_half, scales = "free_y") +
  theme(axis.text.y = element_blank(), strip.background = element_blank(), strip.text = element_blank(),
        legend.direction = "horizontal", legend.position = "bottom") +
  theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_blank()) 

fig_progression
```

```{r selectedmarkers, fig.cap = "Values of selected markers over the course of the disease. Each line represents a patient, stratified by the worst breathing support required over the hospitalization. Color indicates study sites. The vertical scale is logarithmic. Ventilated = any form of ventilation (non-invasive positive-pressure ventilation, mechanical ventilation and extra-corporeal membrane oxygenation), CRP = C-reactive protein [mg/l], D-dimer [ng/ml DDU], Ly = lymphocyte count [10^9/l], IL-6 = Interleukin 6 [ng/l]."}
#data$marker_data %>%
# TODO: use SpO2 in AA as SpO2 native (and vice versa)
plot_marker_data <- function(markers, log_transform, smooth = FALSE, max_patients = NULL, max_day = NULL) {

  if(length(markers) > 1) {
    facet = facet_grid(marker ~ worst_breathing_s, scales = "free_y")
    scale_y_name = "Value"
  } else {
    facet = facet_wrap( ~ worst_breathing_s, nrow = 1)
    unit <- data$marker_data %>% filter(marker == names(markers)) %>% pull(unit) %>% unique()
    scale_y_name <- markers
  }
  
  data_for_plot <- data$marker_data %>% 
    filter(marker %in% names(markers), day >= 0) %>% 
    group_by(marker, patient_id) %>%
    filter(n() > 1) %>%
    ungroup() %>%
    mutate(marker = markers[marker]) 
  
  if(!is.null(max_patients)) {
    patient_markers_to_use <- data_for_plot %>% 
      select(marker, patient_id) %>%
      distinct() %>%
      group_by(marker) %>%
      slice_sample(n = max_patients) 
    
    data_for_plot <- data_for_plot %>%
      semi_join(patient_markers_to_use, by = c("patient_id", "marker"))
  }
  
  if(log_transform) {
    scale_y <- scale_y_log10(scale_y_name)
    data_for_plot <- data_for_plot %>% 
      group_by(marker) %>%
      mutate(value = if_else(value == 0, min(value[value > 0]) / 2, value)) %>%
      ungroup()
  } else {
    scale_y <- scale_y_continuous(scale_y_name)
  }
  
  if(smooth) {
    main_geom <- geom_smooth(aes(group = outcome))
  } else {
    main_geom <- geom_line(alpha = 0.5)
  }
  
  if(!is.null(max_day)) {
    expand <- expand_limits(x = max_day)
  } else {
    expand <- NULL
  }
  
  data_for_plot %>%
    inner_join(data$patient_data, by = c("hospital_id", "patient_id")) %>%
    mutate(outcome = fct_relevel(fct_collapse(outcome, Hospitalized = c("Hospitalized", "Transferred")),
            "Discharged", "Hospitalized", "Death"),
           worst_breathing_s =fct_recode(worst_breathing_s, `Ambient Air` = "AA")) %>%
    ggplot(aes(x = day, y = value,  group = patient_id, color = hospital_id)) + 
    main_geom +
    facet + 
    expand +
    #scale_color_brewer(type = "qual", palette = 2, guide = guide_legend(override.aes = list(alpha = 1, size = 2))) + 
    scale_y +
    scale_x_continuous("Days since hospitalization") +
    scale_color_discrete(guide = FALSE)
    #scale_color_viridis_d(guide = guide_legend(override.aes = list(alpha = 1, size = 2))) + scale_y
}

max_day <- data$marker_data_wide %>% filter(!is.na(CRP)) %>% pull(day) %>% max()
hide_axis_theme <- theme(axis.text.x = element_blank(),
                         axis.line.x = element_blank(),
                         axis.title.x = element_blank(),
                         axis.ticks.x = element_blank())
hide_strip_theme <- theme(strip.background = element_blank(), strip.text = element_blank())
title_theme <- theme(axis.title.y = element_text(size = 10))

fig_markers <- ((plot_marker_data(c("CRP" = "CRP"), log_transform = TRUE, max_day = max_day) + hide_axis_theme + title_theme) /
(plot_marker_data(c("d_dimer" = "D-dimer"), log_transform = TRUE, max_day = max_day) + hide_axis_theme + title_theme + hide_strip_theme) /
(plot_marker_data(c("lymphocyte_count" = "Ly"), log_transform = TRUE, max_day = max_day) + hide_axis_theme + title_theme + hide_strip_theme) /
(plot_marker_data(c("IL_6" = "IL-6"), log_transform = TRUE, max_day = max_day) + title_theme + hide_strip_theme)) 

fig_markers
  #plot_marker_data(c("d_dimer" = "D-dimer", "IL_6" = "IL 6", "CRP" = "CRP"), log_transform = TRUE)
#plot_marker_data(c("d_dimer", "IL_6", "CRP"), log_transform = FALSE)

# plot_marker_data(c("CRP"), log_transform = TRUE)
# plot_marker_data(c("CRP"), log_transform = TRUE, max_patients = 30)
# plot_marker_data(c("CRP"), log_transform = TRUE, max_patients = 30)

```




## Association between patients' characteristics and treatments

As noted above, the nature of the convenience sample did not enforce random assignment of treatments to patients. In fact, patients with worse baseline characteristics, which lead to worse outcomes, were less likely to receive hydroxychloroquine (see Supplementary Figure 3). This clearly creates a bias towards a positive effect of hydroxychloroquine on the outcome (and potentially for other treatments as well - most were used in combination with hydroxychloroquine), which, however, could be false. 

```{r}
# condition on the sum of comorbidities
pd<-data$patient_data
pdd<-within(pd,cnd<-ischemic_heart_disease+has_hypertension_drugs+heart_failure+COPD+    other_lung_disease+    renal_disease+  high_creatinin)
m.hcq_treatment2<-glm(ever_hcq~cnd,pdd,family='binomial')
m.hcq_treatment0<-glm(ever_hcq~1,pdd,subset=!is.na(cnd),family='binomial')
```

Taken quantitatively, the comorbidities known upon hospitalization were informative with respect to the future hydroxychloroquine treatment:
the score representing the cumulative presence of ischemic heart disease, hypertension drugs, former heart failure, COPD, 
other lung diseases, renal disease, or high creatinine 
was associated with a lower chance of taking hydroxychloroquine over the course of the hospitalization 
(the chance was only `r round(100*exp(coef(m.hcq_treatment2)[2]),1)`%, 95% confidence interval 
(`r round(100*exp(confint(m.hcq_treatment2)[2,]),1)`)%,
Chi-square test in the logistic regression model, 
$\chi^2$=`r round(abs(anova(m.hcq_treatment2,m.hcq_treatment0,test='Chisq'))[2,4],2)`, df=1, 
P=`r round(anova(m.hcq_treatment2,m.hcq_treatment0,test='Chisq')[2,5],3)`).

## Association between treatments and outcomes

```{r}

all_hypo_drugs <- read_all_multiverse_res()  %>%
  filter(model_check == "OK", !adj.first_wave, estimand_group == "")

first_fig_multiverse_drugs <- 4
last_fig_multiverse_drugs <- 6
supplementary_figure_markers <- last_fig_multiverse_drugs + 1 
supplementary_figures_multiverse <-  paste0(first_fig_multiverse_drugs, "-", last_fig_multiverse_drugs)
 
```


Here, we focus on hydroxychloroquine and azithromycin as those are the only treatments with larger sample size. We also investigate favipiravir as it is less well reported in the literature. Hydroxychloroquine was dosed almost exclusively in a 5-day regime starting with a loading dose of 800mg on the first day and followed by 400mg. Majority of patients complemented hydroxychloroquine with azithromycin while azithromycin was rarely used alone (see Table \@ref(tab:summarytable)). Azithromycin was most frequently dosed 250 or 500mg/day, but doses ranging from 100mg/day to 1500 mg/day were observed.  Favipiravir was used only at one site with a loading dose of 3600mg on the first day, followed by at most 9 days with a 1600mg dose. All but one of the patients receiving favipiravir also received hydroxychloroquine. Treatment was initiated mostly within two days of admission (see Supplementary Figure 2).



The results of the multiverse analysis for association between hydroxochloroquine, azithromycin and favipiravir usage and death is shown in Figure&nbsp;\@ref(fig:multiverseresultsdrugs) - here, we only show models that were not found to have immediate problems representing the data well or computational issues. Results for all models we tested are reported in  supplementary Figures `r supplementary_figures_multiverse`, with additional details in supplementary statistical analysis. The results do not change noticeably when only patients from the first wave are included (supplementary Figures `r supplementary_figures_multiverse`).

Most models report that using hydroxychloroquine is associated with lower risk of death. We must however bear in mind the potential bias noted in the previous section. Also, we see that for the HMM models, as we add adjustments the credible intervals do not widen but instead shift towards zero. This is a weak indication that further adjustments could drive the effect towards zero. We did not attempt to model additional adjustments as the models became computationally unstable. The case of hydroxychloroquine serves as a "control group" for our other results - since randomized trials give us high confidence that hydroxychloroquine does not substantially reduce mortality, we can be quite certain the associations we observe for hydroxychloroquine are just a measure of bias in the data. Additionally, our models either cannot determine the sign of association between azithromycin and  risk of death or even show an increase in risk of death. This serves as a weak evidence that a substantial improvement in mortality from azithromycin is unlikely.  

Most models exclude very strong association between increased risk of death and using favipiravir, but our data are necessarily quite limited, which is reflected in the very wide uncertainties around estimates. We also cannot put strict bounds on the association between favipiravir and length of hospitalization.

We also examined the association between treatments and length of hospital stay for all the patients that survived. Almost all models cannot discern the sign of the association for all treatments examined (Supplementary Figures `r supplementary_figures_multiverse`). Similarly, we studied the association between D-dimer and Interleukin 6 and outcomes, with unconclusive results as well (Supplementary Figure `r supplementary_figure_markers` ) 


```{r multiverseresultsdrugs, fig.height=7, fig.width=8.5, fig.cap="Estimates of model coefficients for association between treatments and main outcomes. Each row represents a model - Categorical 7/28 = Bayesian categorical regression for state at day 7/28, Bayes Cox = Bayesian version of the Cox proportional hazards model with a binary outcome, Cox (single) = frequentist Cox model with a binary outcome, Cox (competing) = frequentist Cox model using competing risks (as in Figure \\@ref(fig:modelstates)a), HMM A = Bayesian hidden-Markov model as in Figure \\@ref(fig:modelstates)b with predictors for rate groups, HMM B = Bayesian hidden-markov model as in Figure \\@ref(fig:modelstates)b with predictors for individual rates, HMM C = Bayesian hidden-Markov model as in Figure \\@ref(fig:modelstates)c. For frequentist models, we show maximum likelihood estimate and 95% confidence interval, for Bayesian models we show posterior mean and 95% credible interval. The estimands are either log odds-ratio (Categorical, HMM) or log hazard ratio (Cox variants). In all cases coefficient < 0 means better patient outcome in the treatment group. Vertical lines indicate zero (blue) and substantial increase or decrease with odds or hazard ratio of 3:2 or 2:3 (green). Additionally the factors the model adjusted for are listed - Site = the study site, admitted = Admitted for Covid-19, Supportive = best supportive care initiated, Comorb. = total number of comorbidities, AZ = took azithromycin, HCQ = took hydroxychloroquine, FPV = took favipiravir, C. plasma = received convalescent plasma.  "}


#In the current dataset, we see a possibly strong negative association between using hydroxychloroquine and risk of death across all models, although for several models we cannot rule out that the association is of negligible strength. Across all models, the data offer no definitive conclusions on the association between taking hydroxychloroquine and length of hospital stay (represented as risk for being discharged). After adjusting for hydroxychloroquine usage, we also cannot make any strong claims on the association of using azithromycin with either outcome. In all cases, the results seem to not be strongly affected by model choice.


my_lims <- c(-5.5,3.5)
multiverse_hcq1 <- plot_multiverse(all_hypo_drugs %>% filter(hypothesis == "hcq_death"), x_limits = my_lims, adjustments_to_hide = "first_wave")
multiverse_az1 <- plot_multiverse(all_hypo_drugs %>% filter(hypothesis == "az_death"), x_limits = my_lims, adjustments_to_hide = "first_wave")

# multiverse_fpv1 <- plot_multiverse(all_hypo_drugs %>% filter(hypothesis == "favipiravir_death"))
# multiverse_fpv2 <- plot_multiverse(all_hypo_drugs %>% filter(hypothesis == "favipiravir_hospital"))



# ((multiverse_hcq1 & hide_axis_theme) / (multiverse_hcq2 & hide_axis_theme) / (multiverse_az1 & hide_axis_theme) / (multiverse_az2 & hide_axis_theme) / (multiverse_fpv1 & hide_axis_theme) / (multiverse_fpv2)) + plot_layout(heights = c(1, 0.65,0.8,0.4, 0.8,0.3)) & theme(axis.title.y = element_blank())

fpv_lims <- c(-12,2)

multiverse_fpv1 <- plot_multiverse(all_hypo_drugs %>% filter(hypothesis == "favipiravir_death"), x_limits = fpv_lims, adjustments_to_hide = "FPV")

((multiverse_hcq1 & hide_axis_theme) / (multiverse_az1 & theme(axis.title.x = element_blank())) / multiverse_fpv1)  + plot_layout(heights = c(0.8, 0.7,0.70)) & theme(axis.title.y = element_blank())


```

## Prognostic models are not better than just using age

Following Wynants et al.[@http://zotero.org/users/5567156/items/TS57HJ3T] we found five prediction models we were able to recompute: Li et al. report the ACP index [@http://zotero.org/users/5567156/items/EN4GICJ6] combining CRP and age to form 3 grades, Chen & Liu [@http://zotero.org/users/5567156/items/4DDUVEKS] report a continuous score using age, CRP, D-dimer and lymphocyte count,
Shi et al. [@http://zotero.org/users/5567156/items/X4GWJIP5] use age, sex and hypertension to form 4 grades, Caramelo et al. use age, sex, hypertension, diabetes, cardiac disease, chronic respiratory disease and cancer to form a continuous score [@http://zotero.org/users/5567156/items/3A2RN4ZS], Bello-Chavolla et al. [@http://zotero.org/users/5567156/items/INZVABQI] use age, diabetes, obesity, pneumonia, chronic kidney disease, COPD and immunosuppression to build a score ranging from -6 to 22. For the latter two scores we had to impute some of the predictors as they had no immediate equivalent in our dataset. The outcomes present in the studies were: 12-day mortality, 30-day mortality and mortality without any further details, here we report results for both 12-day and 30-day mortality. Full details on the scores and how we used our dataset to compute them is given in the supplementary statistical analysis. 

All prognostic models we tested performed similarly to or notably worse than using age as the only predictor and also worse than originally reported (Figure&nbsp;\@ref(fig:riskscores)). Additionally, some publications did not provide enough detail to unambiguously reconstruct how the score and/or outcome was assessed. We thus concur with Wynants et al. [@http://zotero.org/users/5567156/items/TS57HJ3T] that reported prediction scores are at high risk of bias and need additional careful evaluation.


```{r riskscores, fig.cap="Performance of tested prediction scores as measured by AUC. AUC = 1 means perfect prediction while AUC $\\leq$ 0.5 means that the score is worse than random guess and a better prediction would be obtained by reversing the score (marked by thick blue line). The line ranges represent the bootstrapped 95% confidence intervals. Red dots show results computed in present study - individual dots vary in the outcome measured (12-day or 30-day mortality) and potentially on how ambiguities in score computation were resolved, although this rarely makes a big difference. Cyan triangles show AUC as reported by the original authors or recomputed based on their published data. When the confidence interval or the AUC of the original study is not shown, it means that the value was not reported by the authors and not enough information to recompute it was given."}
col_types_auc <- cols(
  auc = col_double(),
  auc_low = col_double(),
  auc_high = col_double(),
  outcome = col_character(),
  score = col_character(),
  note = col_character(),
  subgroup = col_character()
)
all_auc <- read_csv(here::here("manuscript", "all_auc.csv"), col_types = col_types_auc, na = "NA") %>% filter(subgroup != "(admission)")
all_auc_orig <- read_csv(here::here("manuscript", "all_auc_orig.csv"), col_types = col_types_auc, na = "NA") %>% filter(subgroup != "(admission)")

compare_auc_to_orig(all_auc_orig,
                    all_auc, show_outcome = FALSE)


```



# Conclusions

Our data show the extent of between-patient variability in progression of the disease in terms of both length of hospital stay, duration of various types of breathing support and basic markers.

We provide very weak observational evidence against a substantial beneficiary effect of using azithromycin (both with or without hydroxychloroquine) and against substantial negative effect of using favipiravir in hospitalized Covid-19 patients. We also observed better outcomes associated with taking hydroxychloroquine, which is likely linked to substantial confounding by indication.
Where our results contradict randomized trials, the most likely explanation is systematic bias in our dataset.

A lesson from our analysis is that the assessment of treatment efficacy from observational data is very sensitive to modelling assumptions while it is usually almost impossible to determine which of the models is more likely to reflect reality (if any). We believe that using multiverse analysis is an appropriate way to explore data in such contexts as it lets us be transparent about this sensitivity. We further believe that using hidden Markov models is a promising complement to the standard Cox proportional hazards analysis when detailed information on disease progression is available, particularly because it lets us impose additional structure on the model and thus make inferences with more disease states than would be possible to handle in the Cox framework, making better use of the available data.

Additionally, our experience indicates that a substantial fraction of published prognostic models will perform much worse on new patients than on the datasets they were built for and that external validation is crucial. We suggest that comparing the prognostic models against simple baselines (e.g. decade of age as the single predictor) should be a first step in validation. Furthermore, some of the published scores lack enough information to let others implement the score in the same way.

# Conflict of Interest

The authors declare that there is no conflict of interest.


# Acknowledgements

This work was supported by ELIXIR CZ research infrastructure project (MEYS Grant No: LM2018131) including access to computing and storage facilities.

# References
