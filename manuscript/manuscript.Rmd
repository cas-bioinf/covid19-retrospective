---
title: "Detailed disease progression of 191 patients hospitalized with Covid-19 in the Czech Republic: An exploratory analysis" 
output: 
  #rticles::arxiv_article
  #pdf_document
  # bookdown::pdf_document2:
  #    toc: false
  bookdown::word_document2: 
     toc: false
  # bookdown::pdf_book: 
  #    base_format: rticles::arxiv_article
abstract: "We collected a multi-centric retrospective dataset of patients who were admitted to N hospitals in Czech Republic and tested positive for SARS-CoV-2. The dataset contains baseline patient characteristics, breathing support required, pharmacological treatment received and multiple markers on daily resolution. To assess association between treatments, markers and patient outcomes we performed multiverse analysis, observing how the conclusions change between defensible choices of statistical model, predictors included in the model and other analytical degrees of freedom. Additionally we performed external validation of several proposed prognostic models for Covid-19 severity."
bibliography: Covid19.json
date: "Version: `r format(Sys.time(), '%Y-%m-%d')`"
---


```{r setup, echo=FALSE, message=FALSE, warning = FALSE, results = "hide"}
knitr::opts_chunk$set(echo = FALSE)

devtools::load_all()
library(tidyverse)
library(patchwork)
theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()
wide <- data$marker_data_wide

n_patients <- nrow(data$patient_data)
n_hospitals <- length(unique(data$patient_data$hospital_id))
```

# Introduction 

The Covid-19 pandemic, caused by severe acute respiratory syndrome coronavirus (SARS-CoV-2) has, as of September 2020 led to over 28 million cases and over 900 000 deaths. Proposed treatments include antivirals approved for other indications (Chloroquine, Hydroxychloroquine, Lopinavir/Ritonavir, Remdesivir, Favipiravir, Umifenovir), Azithromycin, corticosteriods, immunoglobulins, Tocilizumab and convalescent plasma [@http://zotero.org/users/5567156/items/8XWTUMUI; @http://zotero.org/users/5567156/items/6Q8Z8VJR; TODO]. Currently, the only treatment that exhibited positive effects in randomized trials is the corticosteriod Dexamethasone for severe cases [@http://zotero.org/users/5567156/items/IW6VZ53Q; @http://zotero.org/users/5567156/items/5VAKEW58]. While initially promising, Hydroxychloroquine has failed to show benefit for both hospitalized patients [@http://zotero.org/users/5567156/items/9X3UH8ZM], as early treatment [@http://zotero.org/users/5567156/items/G6KZKVMI], and as both pre- and post-exposure profylaxis [@http://zotero.org/users/5567156/items/7C23YCV5; @http://zotero.org/users/5567156/items/GMR9FX9Z; @http://zotero.org/users/5567156/items/H4CLJNUR]. Further, no improvement could be discerned when adding Azithromycin to Hydroxychloroquine therapy [@http://zotero.org/users/5567156/items/BQLRZGTQ]. Similarly, Lopinavir/Ritonavir also did not show benefit [@http://zotero.org/users/5567156/items/6I6GAVWU]. No benefit was observed for convalscent plasma [@http://zotero.org/users/5567156/items/UEXLDJCB; @http://zotero.org/users/5567156/items/BHGT88US] For additional summary see [@http://zotero.org/users/5567156/items/YP62P6XJ].

In observational studies, Hydroxychloroquine was often found to be associated with better outcomes [e. g., @http://zotero.org/users/5567156/items/WZPNBRYN; @http://zotero.org/users/5567156/items/4HR7MUJ6; @http://zotero.org/users/5567156/items/NXC9CDI9]

High IL-6, D-dimer values were observed to be associated with outcome and disease severity [@http://zotero.org/users/5567156/items/ID7F3XIH].
Large study of electronic health records [@http://zotero.org/users/5567156/items/ARTB8HYZ] showed TODO.

An ongoing challenge in evalutating Covid-19 treatments is that the analysis and interpretation of the data is often inappropriate or misleading, most notably interpreting lack of evidence due to small sample size as evidence of no effect [see e.g., @http://zotero.org/users/5567156/items/5PZEEPJV; @http://zotero.org/users/5567156/items/AZDZHLJV].

Additionally, many methods for predicting disease severity of Covid-19 were published, but the methods are at high risk of bias and lack external validation [@http://zotero.org/users/5567156/items/TS57HJ3T].

# Methods


## Data Collection
A convenience sample of patients... Patients over the age of 18 were included if they had PCR-confirmed infection of SARS-CoV-2 and were not participating in a clinical evaluation of any Covid-19 pharmacotherapy. Full protocol for data collection is attached in the supplementary material. The study was approved by the Ethical committees of TODO.

## Statistical analysis

Since many details of analysis may influence the conclusions made, we performed multiverse analysis [@http://zotero.org/users/5567156/items/DXWM259V] and report results for all the hypothesis tested across multiple different models using both frequentist and Bayesian paradigms. For each model class we worked with several possible sets of adjustments and - where applicable - with multiple estimands of the outcome as different tasks require different estimands [@http://zotero.org/users/5567156/items/MH797GNC]. All analysis wes performed in the R language [@http://zotero.org/users/5567156/items/67XKBC2W], visualisations and data cleaning was run with the `tidyverse` package [@http://zotero.org/users/5567156/items/8EWY8TKM]. Complete code for all analyses can be found at TODO.

First class of models are frequentist multistate models under the proportional hazards assumption as implemented in the `coxph` function from the `survival` package [@http://zotero.org/users/5567156/items/I9UVTUJF]. We primarily use a model with competing risks for death and discharge from hospital (see Figure&nbsp;\@ref(fig:modelstates)a).

Second class of models are Bayesian hidden Markov models of disease progression implemented via a custom extension to the `brms` package [@http://zotero.org/users/5567156/items/7ER3ZSER]. The parametrization of the HMM is inspired by [@http://zotero.org/users/5567156/items/F9K2L5Q8]: the actual process of disease is assumed to be continuous and allow only for transitions between neighbouring states (as shown in Figure&nbsp;\@ref(fig:modelstates)b, c). The total probability of transition between any two states over the period of a day is then computed as the total probability of transition across all possible paths. This class of models does not satisfy the proportional hazards assumption, instead, it is assumed the process has the Markov property - i.e. that the (potentially unobserved) state and the covariates at a given day contain all the information to determine probabilities of the states on the next day. We use two versions of such models, one working solely with the observed breathing support and one assuming a hidden improving/worsening distinction.


```{r modelstates, fig.cap="States used in the competing risk model (a) and in the two hidden Markov model variants (b,c). AA = Ambient air, Oxygen = Nasal oxygen, Ventilated = any form of vantilation, including non-invasive positive-pressure ventilation, mechanical ventilation and extra-corporeal membrane oxygenation. In all models the 'Death' and 'Discharged' states are terminal. In the second hidden Markov model (c), the 'Improving' and 'Worsening' variants of each non-terminal state are not observable - only the breathing support is observed and improving/worsening is inferred from progression of the disease." }
knitr::include_graphics(here::here("manuscript","static_figs","model_states.png"), auto_pdf = TRUE)
```

When markers are used as predictors in both the hidden Markov models and the competing risks model, we impute the missing values using either the maximum of the marker so far or the last-known value of the marker.  

Additionally we used joint models for longitudinal and time-to-event data from `stan_jm` function in the `rstanarm` package [@http://zotero.org/users/5567156/items/KHJGLQS5]. Those models include a longitudinal component to model the evolution over time of marker for each patient and a time-to-event component which assumes proportional-hazards for an event. The estimated value of the marker is then used as one of the predictors in the time-to-event component. 

Finally we used a set of Bayesian regression models implemented with the `brms` package [@http://zotero.org/users/5567156/items/7ER3ZSER]. Those included overall survival, state at day 7 or 28 as either binary or ordinal outcome, Bayesian version of the Cox proportional-hazards model and time-to-event models.

```{r}
#Since `stan_jm` does not support competing risks, we imputed the second event...
```

Except for age, sex and comorbidities, all covariates are treated as time-varying, e.g. the effect of taking a drug is only included for the days after the drug was taken. 

```{r}
#Sex differences are to be expected for both sociological and biological [@http://zotero.org/users/5567156/items/5KQZ3XEE] reasons.
```

## Evaluating prognostic models

We searched the living systematic review of Covid-19 prognostic models [@http://zotero.org/users/5567156/items/TS57HJ3T] for models that could be applied to our dataset (i.e. where we have gathered all the input features). This resulted in five usable models: [@http://zotero.org/users/5567156/items/EN4GICJ6; @http://zotero.org/users/5567156/items/INZVABQI; @http://zotero.org/users/5567156/items/3A2RN4ZS; @http://zotero.org/users/5567156/items/4DDUVEKS; @http://zotero.org/users/5567156/items/X4GWJIP5]. We used 

# Results


In total, we were able to gather data for `r n_patients` patients, see Table \@ref(tab:summarytable) for the overall characteristics of the patient sample and several subgroups we used in the analysis.


```{r summarytable, echo=FALSE}

data_table_1 <- rbind(
  data$patient_data %>% mutate(group = "All"),
  data$patient_data %>% mutate(group = if_else(ever_hcq, "HCQ", "No HCQ")),
  data$patient_data %>% filter(any_d_dimer) %>% mutate(group = "Measured D-dimer"),
  data$patient_data %>% filter(any_IL_6) %>% mutate(group = "Measured IL-6")
  )


data_table_1 %>% group_by(group) %>% 
  summarise(
    N = n(),
    `Distinct sites` = length(unique(hospital_id)),
    Male = sum_percent(sex == "M"),
    `Age (mean, IQR)` = mean_iqr(age),
    `Admitted for Covid` = sum_percent(admitted_for_covid),
    `Took Azithromycin` = sum_percent(ever_az),
    `Took Dexamethasone` = sum_percent(ever_dexamethasone),
    `Took Favipiravir` = sum_percent(ever_favipiravir),
    `Took Remdesivir` = sum_percent(ever_remdesivir),
    `Convalescent plasma` = sum_percent(ever_convalescent_plasma),
    `Ischemic Heart Disease` = sum_percent(ischemic_heart_disease),
    `Takes antihypertensives` = sum_percent(has_hypertension_drugs),	
    `Heart Failure` = sum_percent(heart_failure),
    COPD = sum_percent(COPD),
    Asthma = sum_percent(asthma),
    `Other lung disease` = sum_percent(other_lung_disease),
    Diabetes = sum_percent(diabetes),
    `Renal Disease` = sum_percent(renal_disease),
    `Liver Disease` = sum_percent(liver_disease),
    `Smoking` = sum_percent(smoking),
    `BMI (mean, IQR)` = mean_iqr(BMI),
    Deceased = sum_percent(outcome == "Death"),
    Discharged = sum_percent(outcome == "Discharged"),
    .groups = "drop"
  ) %>%
  mutate(group = factor(group, levels= c("All", "HCQ", "No HCQ", "Measured D-dimer","Measured IL-6"), ordered = TRUE)) %>%
  arrange(group) %>%
  as.data.frame() %>%
  column_to_rownames("group") %>%
  t() %>% 
  knitr::kable(caption = "Patient characteristics. Note that the 'Measured D-dimer' and 'Measured IL-6' are neither exclusive nor exhaustive.", booktabs = TRUE)
```


In Figure&nbsp;\@ref(fig:progression) we show the disease progression for all patients.

```{r progression, fig.cap="Disease progression for all patients included in the study as determined by breathing support required."}
my_paste <- function(x) {
  paste0(as.integer(x), collapse = "")
}



data_for_fig_progression <- wide  %>% 
  filter(!is.na(breathing_s), day >= 0) %>%
  arrange(hospital_id, patient_id, day) %>%
  mutate(patient_id = factor(patient_id), patient_id = fct_reorder(patient_id, breathing_s,  .fun = my_paste, .desc = FALSE)) %>%
  mutate(first_half = as.integer(patient_id) < length(levels(patient_id)) / 2 + 1, 
         is_outcome =  breathing_s %in% c("Discharged", "Death"),
         breathing_s = fct_recode(breathing_s, `Ambient air` = "AA")
         ) 

data_for_fig_progression %>% 
  filter(!is_outcome) %>%
  ggplot(aes(x = day, y = patient_id, fill = breathing_s)) + 
  geom_tile(height = 0.7) + 
  geom_point(data = data_for_fig_progression %>% filter(is_outcome) %>% mutate(outcome = factor(breathing_s, ordered = FALSE)),
             inherit.aes = FALSE, aes(x = day, y = patient_id, shape = outcome), size = 0.9) +
  scale_fill_viridis_d("", direction = -1) +
  scale_x_continuous("Days since hospitalization") +
  scale_shape_manual("", values = c(1, 15), guide = guide_legend(override.aes = list(size = 4))) +
  facet_wrap(~first_half, scales = "free_y") +
  theme(axis.text.y = element_blank(), strip.background = element_blank(), strip.text = element_blank(),
        legend.direction = "horizontal", legend.position = "bottom") +
  theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_blank()) 

```

```{r}
bayesian_cols <- cols(
  hypothesis = col_character(),
  model = col_character(),
  adjusted = col_character(),
  estimand = col_character(),
  widest_CI_excl_reference = col_double(),
  point_estimate = col_double(),
  ci_low = col_double(),
  ci_high = col_double()
)
res_bayesian <- 
  rbind(read_csv(here::here("manuscript", "hmm_res.csv"), col_types = bayesian_cols),
        read_csv(here::here("manuscript", "analysis_brms.csv"), col_types = bayesian_cols),
        read_csv(here::here("manuscript", "jm_res.csv"), col_types = bayesian_cols)
        )

frequentist_cols <- cols(
  hypothesis = col_character(),
  model = col_character(),
  adjusted = col_character(),
  p_value = col_double(),
  ci_low = col_double(),
  ci_high = col_double()
)

res_frequentist <- 
  rbind(read_csv(here::here("manuscript", "competing_risks_res.csv"), col_types = frequentist_cols))

all_hypo <- rbind(res_bayesian %>% select(-widest_CI_excl_reference), 
      res_frequentist %>% select(-p_value)) %>%
    inner_join(hypotheses_df, by = c("hypothesis" = "name")) 


```

## Association between treatment, markers and outcomes

```{r multiverseresultsdrugs, fig.height=7, fig.width=8.5, fig.cap="Estimates of model coefficients (log hazard ratios) for association between treatments and main outcomes. Each row represents a model - HMM = Bayesian hidden-markov model, coxph = Frequentist competing risks model. Additionally the factors the model adjusted for are listed - supportive = best supportive care initiated, comorbidities_sum = total number of comorbidities, admitted = admitted for Covid-19, az = took Azithromycin, hcq = took Hydroxychloroquine. For frequentist models, we show maximum likelihood estimate and 95% confidence interval, for Bayesian models we show posterior mean and 95% credible interval."}
plot_multiverse <- function(hypo_res) {
  hypo_res %>% mutate(
    id = rev(1:n()),
    model_adjusted = paste0(model, " - ", adjusted),
    label = factor(model_adjusted, levels = model_adjusted, labels = str_wrap(model_adjusted, 30)),
    model_adjusted_fct = fct_reorder(factor(model_adjusted),  id)) %>%
  ggplot(aes(x = point_estimate, xmin = ci_low, xmax = ci_high, y = model_adjusted_fct)) +
  geom_vline(xintercept = 0, color = "blue") +
  geom_point() +
  geom_errorbarh() + 
  facet_wrap(~caption, ncol = 1, scales = "free_y") +
  scale_x_continuous("Model coefficient estimate") +
  scale_y_discrete("")
  #theme(axis.text.y = element_text(size = 6))
}

multiverse_hcq <- plot_multiverse(all_hypo %>% filter(group == "hcq"))
multiverse_az <- plot_multiverse(all_hypo %>% filter(group == "az"))

(multiverse_hcq / multiverse_az) + plot_layout(heights = c(2.2,1))

```

```{r}
plot_multiverse(all_hypo %>% filter(group == "favipiravir"))
```


```{r multiverseresultsmarkers, fig.height=2.5, fig.width=6, fig.cap="Estimates of model coefficients (log hazard ratios) for association between markers and death. Each row represents a model - HMM = Bayesian hidden-markov model, jm = Joint longitudinal and time-to-event model. Additionally the factors the model adjusted for are listed - hcq = took Hydroxychloroquine. We show posterior mean and 95% credible interval."}
plot_multiverse(all_hypo %>% filter(group == "markers"))
```

The results of the multiverse analysis for association between drugs used and outcomes is shown in Figure&nbsp;\@ref(fig:multiverseresultsdrugs). In the current dataset, we see a possibly strong negative association between using Hydroxychloroquine and risk of death across all models, although for several models we cannot rule out that the association is of negligible strength. Across all models, the data offer no definitive conclusions on the association between taking Hydroxychloroquine and length of hospital stay (represented as risk for being discharged). After adjusting for Hydroxychloroquine usage, we also cannot make any strong claims on the association of using Azithromycin with either outcome. In all cases, the results seem to not be strongly affected by model choice.

We additionally investigated the association of several markers with disease progression. Due to low number of patients in the current dataset, the results are inconclusive and heavily dependent on model choice. All of the coefficient estimates can be seen in Figure&nbsp;\@ref(fig:multiverseresultsmarkers)

## Survey of antimicrobial treatment

## Evaluating prediction models

The ACP index [@http://zotero.org/users/5567156/items/EN4GICJ6] is a simple score that categorizes the patients into 3 categories based on age and C-reactive protein (CRP): grade 1 (age $<$ 60 years and CRP $<$ 34 mg/L), grade 2 (age $\geq$ 60
years and CRP $<$ 34 mg/L or age $<$ 60 years and CRP $\geq$ 34 mg/L), grade 3 (age $\geq$ 60 years and CRP $\geq$ 34 mg/L) and was evaluated primarily on 12-day mortality. Despite the score being developed on patients in Wuhan, China, the 12-day mortality in our dataset is in rough agreement with the values in the original manuscript as shown in Table \@ref(tab:acpresults).      


```{r acpresults, echo=FALSE}
acp_data <- wide %>%  
  group_by(patient_id) %>%
  filter(any(!is.na(CRP))) %>%
  summarise(
    first_CRP_day = min(day[!is.na(CRP)]),
    first_CRP = CRP[day == first_CRP_day],
    worst_breathing_12 = max(breathing[day >= first_CRP_day & day <= first_CRP_day + 12]),
    .groups = "drop") %>% 
  inner_join(data$patient_data, by = c("patient_id")) %>%
  filter(outcome %in% c("Death","Discharged") | last_record - first_CRP_day >= 12) %>%
  mutate(    
    alive_12 = last_record > first_CRP_day + 12 | outcome == "Discharged",
    ACP_grade = case_when(
       age < 60 & first_CRP < 34 ~ 1,
       age >= 60 & first_CRP >= 34 ~ 3,
       TRUE ~ 2
    ) 
  )

acp_data %>%
  group_by(ACP_grade) %>%
  summarise(`patients` = n(), `12-day mortality` = scales::percent(mean(!alive_12), accuracy = 0.1), .groups = "drop") %>%
  arrange(ACP_grade) %>%
  mutate(`Li et al. 95% CI` = c("0%", "0 - 11.3%", "19.8 - 44.3%")) %>%
  rename(`ACP grade` = ACP_grade) %>%
  knitr::kable(booktabs = TRUE, caption = "Comparing the 12-day mortality based on ACP score (where available) with the 95\\% confidence intervals (CI) for 12-day mortality reported by Lu et al.")

# acp_data %>%
#   group_by(ACP_grade, worst_breathing_12) %>%
#   summarise(mean(alive_12))
```

(TODO: the other prediction models)



# Conclusions

Will be written once we have the full dataset.

Where our resutls contradict randomized trials, the most likely explanation is systematic bias in our dataset.

# References
