---
title: "Validating risk scores"
output: 
  bookdown::pdf_document2: 
     toc: false
bibliography: Covid19.json
date: "Version: `r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, echo=FALSE, message=FALSE, warning = FALSE, results = "hide"}
knitr::opts_chunk$set(echo = FALSE)

devtools::load_all()
library(tidyverse)
library(patchwork)
theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()
```

```{r}
baseline <- data$patient_data %>%
  mutate(alive_12_admission = case_when(
    last_record >= 12 ~ TRUE,
    outcome == "Discharged" ~ TRUE,
    outcome == "Death" ~ FALSE,
    TRUE ~ NA),
    alive_30_admission = case_when(
    last_record >= 30 ~ TRUE,
    outcome == "Discharged" ~ TRUE,
    outcome == "Death" ~ FALSE,
    TRUE ~ NA)
  )
    
```


# ACP

The ACP index [@http://zotero.org/users/5567156/items/EN4GICJ6] is a simple score that categorizes the patients into 3 categories based on age and C-reactive protein (CRP): grade 1 (age $<$ 60 years and CRP $<$ 34 mg/L), grade 2 (age $\geq$ 60
years and CRP $<$ 34 mg/L or age $<$ 60 years and CRP $\geq$ 34 mg/L), grade 3 (age $\geq$ 60 years and CRP $\geq$ 34 mg/L) and was evaluated primarily on 12-day mortality. Despite the score being developed on patients in Wuhan, China, the 12-day mortality in our dataset is in agreement with the values in the original manuscript as shown in Table \@ref(tab:acpresults).     

```{r acpresults, echo=FALSE}
acp_data <- data$marker_data_wide %>%  
  group_by(patient_id) %>%
  filter(any(!is.na(CRP))) %>%
  summarise(
    first_CRP_day = min(day[!is.na(CRP)]),
    first_CRP = CRP[day == first_CRP_day],
    worst_breathing_12 = max(breathing[day >= first_CRP_day & day <= first_CRP_day + 12]),
    .groups = "drop") %>% 
  inner_join(data$patient_data, by = c("patient_id")) %>%
  filter(outcome %in% c("Death","Discharged") | last_record - first_CRP_day >= 12) %>%
  mutate(    
    alive_12 = case_when(last_record >= first_CRP_day + 12 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_30 = case_when(last_record >= first_CRP_day + 30 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    ACP_grade = case_when(
       age < 60 & first_CRP < 34 ~ 1,
       age >= 60 & first_CRP >= 34 ~ 3,
       TRUE ~ 2
    ) 
  )

acp_data %>%
  filter(!is.na(alive_12)) %>%
  group_by(ACP_grade) %>%
  summarise(`patients` = n(), `12-day mortality` = sum_percent(!alive_12), .groups = "drop") %>%
  arrange(ACP_grade) %>%
  mutate(`Li et al. 95% CI` = c("0%", "0 - 11.3%", "19.8 - 44.3%")) %>%
  rename(`ACP grade` = ACP_grade) %>%
  knitr::kable(booktabs = TRUE, caption = "Comparing the 12-day mortality based on ACP score (where available) with the 95\\% confidence intervals (CI) for 12-day mortality reported by Lu et al.")

# acp_data %>%
#   group_by(ACP_grade, worst_breathing_12) %>%
#   summarise(mean(alive_12))
```
```{r}
li_et_al_data <- data.frame(
  ACP_grade = c(rep(1, 194), rep(2, 145), rep(3, 95)),
  alive_12 = c(rep(TRUE, 194), #Grade 1, 0% mortality
               rep(FALSE, 8), rep(TRUE, 145-8), #Gred 2, 5.6% mortality
               rep(FALSE, 32), rep(TRUE, 95 - 32) #Grade 3, 33.2% mortality
  ))
  
acp_auc_orig <- my_auc(alive_12 ~ ACP_grade, li_et_al_data)
acp_auc_orig$summary
```


```{r}
outcome_caption = c("alive_12" = "12-day mortality", "alive_30" = "30-day mortality")
score_caption = c("ACP_grade" = "Li et al. (ACP)")

my_auc <- function(f, d) {
  roc = pROC::roc(f, d, direction = "<", levels = c(TRUE, FALSE))
  ci = pROC::ci.auc(roc)
  
  outcome = as.character(formula.tools::lhs(f))
  score = as.character(formula.tools::rhs(f))
  

  list(roc = roc,
       summary = data.frame(
         auc = ci[2],
         auc_low = ci[1],
         auc_high = ci[3],
         outcome = outcome,
         score = score
       )
  )
}

plot_my_auc <- function(my_auc) {
  caption = paste0(score_caption[my_auc$summary$score], ", ", outcome_caption[my_auc$summary$outcome])
  plot(my_auc$roc, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE, main = caption)
}

plot_all_auc <- function(my_auc_list) {
  my_auc_list %>% walk(plot_my_auc)
}
```


```{r}
acp_auc <- list(
  alive_12 = my_auc(alive_12 ~ ACP_grade, acp_data),
  alive_30 = my_auc(alive_30 ~ ACP_grade, acp_data)
)
plot_all_auc(acp_auc)

```


# Chen and Liu

$$
Score = −4.211+0.013 \times CRP+0.059 \times Age +0.112 \times DD −1.984 \times LYM
$$

The paper does not have units, but the web app

> patients  who  were  with  >10%  missing  values,  stayed  in  the  hospital  <  7  days,  afflicted  by  a  severe  disease  before  admission  (e.g.,  cancer,  aplastic  anemia,  and  uremia),  were  unconscious  at  admission, and were directly admitted to the intensive care unit (ICU) were excluded.

> Non-normally   distributed   continuous   variables   were   transformed   using   a   Box-Cox   transformation.

Slightly unclear how they computed the outcome.

CRP: mg/l
D-dimer: ug / mL FEU (we use ng/ml DDU, FEU value is double the DDU)
Lymphocytes: 10^9 / L

```{r}
data$marker_data %>% filter(marker %in% c("CRP", "d_dimer", "lymphocyte_count")) %>%
  select(marker, unit) %>% distinct()
```



Results for the validation dataset:
AUROC = 0.881
Cutoff (0.5)
Sensitivity = 0.839
Specificity = 0.794




Precise coefficient values and the CI range determined by reverse engineering the webapp at https://phenomics.fudan.edu.cn/risk_scores/


```{r}
chen_liu_data <- data$marker_data_wide %>%  
  mutate(has_all_values = !is.na(CRP) & !is.na(d_dimer) & !is.na(lymphocyte_count),
         d_dimer_converted = d_dimer * 2 / 1000) %>%
  group_by(patient_id) %>%
  filter(any(has_all_values)) %>%
  summarise(
    first_day = min(day[has_all_values]),
    first_CRP = CRP[day == first_day],
    first_d_dimer_converted = d_dimer_converted[day == first_day],
    first_lymphocyte_count = lymphocyte_count[day == first_day],
    breathing_first = breathing[day == first_day],
    .groups = "drop") %>% 
  inner_join(data$patient_data, by = c("patient_id")) %>%
  mutate(    
    inclusion_criterium = breathing_first < "NIPPV" & (outcome %in% c("Discharged", "Death") | last_record >= first_day + 7),
    score =  -4.21167 + 0.058699 * age + 0.013391 * first_CRP + 0.112055 * first_d_dimer_converted - 1.983733 * first_lymphocyte_count,
    risk = 1 / (1 + exp(-score)),
    risk_lower = 1 / (1 + exp(-score + 1.96*0.1721)),
    risk_upper = 1 / (1 + exp(-score - 1.96*0.1721)),
    alive_12 = case_when(last_record >= first_day + 12 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_30 = case_when(last_record >= first_day + 30 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_all = case_when(outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_imputed = outcome != "Death"
    
                         
  ) %>% select(age, starts_with("first"), score, starts_with("risk"), breathing_first, starts_with("alive"), inclusion_criterium)
```

```{r}
chen_liu_data %>% ggplot(aes(x = score, y = alive_30)) + geom_point()
```


```{r}
roc_chen_liu_12 <- pROC::roc(alive_12 ~ score, chen_liu_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_chen_liu_30 <- pROC::roc(alive_30 ~ score, chen_liu_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_chen_liu_all <- pROC::roc(alive_all ~ score, chen_liu_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)

roc_chen_liu_12_incl <- pROC::roc(alive_12 ~ score, chen_liu_data %>% filter(inclusion_criterium), direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_chen_liu_30_incl <- pROC::roc(alive_30 ~ score, chen_liu_data %>% filter(inclusion_criterium), direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_chen_liu_all_incl <- pROC::roc(alive_all ~ score, chen_liu_data %>% filter(inclusion_criterium), direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_chen_liu_imputed_incl <- pROC::roc(alive_imputed ~ score, chen_liu_data %>% filter(inclusion_criterium), direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)

```



# Shi et al.

1 point for Age >= 50, Male, Hypertension

Not sure what "severe" means

# Caramelo

???


# Bello-Chavolla 

The index given in [@http://zotero.org/users/5567156/items/INZVABQI] is built from following elements:

```{r}
bello_chavolla_table <- rbind(
  data.frame(factor = "Age >= 65 years", score = 3),
  data.frame(factor = "Diabetes", score = 1),
  data.frame(factor = "Diabetes*Age < 40 years", score = 5),
  data.frame(factor = "Age < 40 years", score = -6),
  data.frame(factor = "Obesity", score = 1),
  data.frame(factor = "Pneumonia", score = 7),
  data.frame(factor = "Chronic Kidney Disease", score = 3),
  data.frame(factor = "COPD", score = 1),
  data.frame(factor = "Immunosuppression", score = 1)
)

bello_chavolla_table

```

Of those, our data does not contain Immunosuppresion and Pneumonia. We can however use taking antibiotics within 1 day of hospitalization as an imperfect proxy for pneumonia. We will ignore immunosuppresion in our test. Both of those choices could reduce the performance of the score. 

The authors do not define obesity, so we will use BMI > 30 as threshold for obesity. Our data contains an indicator for "Renal disease" which might be classified slightly differently than "Chronic Kidney Disease".

The authors report C-statistic = 0.830 for mortality on validation dataset - it is unclear how they treat censoring, but they mention 30-day mortality in other part of the paper, so we will focus on 30-day mortality.

```{r}
atb_first_day <- data$marker_data_wide %>% select(patient_id, day, took_antibiotics) %>% 
  group_by(patient_id) %>%
  summarise(atb0 = any(took_antibiotics[day <= 0]), 
            atb1 = any(took_antibiotics[day <= 1]), .groups = "drop")

bello_chavolla_data <- baseline %>%
  inner_join(atb_first_day, by = "patient_id") %>%
  mutate(bc_base =  3 *  (age >= 65) +
           diabetes +
           5 * (diabetes & age < 40) +
           (-6) * (age < 40) +
           obesity +
           3 * renal_disease +
           COPD,
         bc0 = bc_base + 7 * atb0,
         bc1 = bc_base + 7 * atb1
  )
           

```

```{r}
bello_chavolla_data %>% ggplot(aes(x = bc0, y = as.integer(alive_30_admission))) +
  geom_smooth() + geom_jitter(width = 0.3, height = 0.3) 
bello_chavolla_data %>% ggplot(aes(x = bc_base, y = as.integer(alive_30_admission))) +
  geom_smooth() + geom_jitter(width = 0.3, height = 0.3) 

```


```{r}
roc_bc_base_30 <- pROC::roc(alive_30_admission ~ bc_base, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_bc_base_12 <- pROC::roc(alive_12_admission ~ bc_base, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_bc0_30 <- pROC::roc(alive_30_admission ~ bc0, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_bc0_12 <- pROC::roc(alive_12_admission ~ bc0, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_bc1_30 <- pROC::roc(alive_30_admission ~ bc1, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)
roc_bc1_12 <- pROC::roc(alive_12_admission ~ bc1, bello_chavolla_data, direction = "<", levels = c(TRUE, FALSE), plot = TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, print.auc = TRUE)

```


