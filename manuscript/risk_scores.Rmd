---
title: "Validating risk scores"
output: 
  bookdown::pdf_document2: 
     toc: false
bibliography: Covid19.json
date: "Version: `r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, echo=FALSE, message=FALSE, warning = FALSE, results = "hide"}
knitr::opts_chunk$set(echo = FALSE)

devtools::load_all()
library(tidyverse)
library(patchwork)
theme_set(cowplot::theme_cowplot())
data <- read_data_for_analysis()
```

```{r}
at_admission <- data$patient_data %>%
  mutate(alive_12 = case_when(
    last_record >= 12 ~ TRUE,
    outcome == "Discharged" ~ TRUE,
    outcome == "Death" ~ FALSE,
    TRUE ~ NA),
    alive_30 = case_when(
    last_record >= 30 ~ TRUE,
    outcome == "Discharged" ~ TRUE,
    outcome == "Death" ~ FALSE,
    TRUE ~ NA)
  )
    
```


In all of the following we focus on the C-statistic, also often called area under curve (AUC). We compute AUC using the  `pROC` package, which also reports bootstrapped confidence intervals.

# ACP

The ACP index [@http://zotero.org/users/5567156/items/EN4GICJ6] is a simple score that categorizes the patients into 3 categories based on age and C-reactive protein (CRP): grade 1 (age $<$ 60 years and CRP $<$ 34 mg/L), grade 2 (age $\geq$ 60
years and CRP $<$ 34 mg/L or age $<$ 60 years and CRP $\geq$ 34 mg/L), grade 3 (age $\geq$ 60 years and CRP $\geq$ 34 mg/L) and was evaluated primarily on 12-day mortality. Despite the score being developed on patients in Wuhan, China, the 12-day mortality in our dataset is in rough agreement with the values in the original manuscript as shown in Table \@ref(tab:acpresults).     

```{r acpresults, echo=FALSE}
acp_data <- data$marker_data_wide %>%  
  group_by(patient_id) %>%
  filter(any(!is.na(CRP))) %>%
  summarise(
    first_CRP_day = min(day[!is.na(CRP)]),
    first_CRP = CRP[day == first_CRP_day],
    worst_breathing_12 = max(breathing[day >= first_CRP_day & day <= first_CRP_day + 12]),
    .groups = "drop") %>% 
  inner_join(data$patient_data, by = c("patient_id")) %>%
  filter(outcome %in% c("Death","Discharged") | last_record - first_CRP_day >= 12) %>%
  mutate(    
    alive_12 = case_when(last_record >= first_CRP_day + 12 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_30 = case_when(last_record >= first_CRP_day + 30 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    ACP_grade = case_when(
       age < 60 & first_CRP < 34 ~ 1,
       age >= 60 & first_CRP >= 34 ~ 3,
       TRUE ~ 2
    ) 
  )

acp_data %>%
  filter(!is.na(alive_12)) %>%
  group_by(ACP_grade) %>%
  summarise(`patients` = n(), `12-day mortality` = sum_percent(!alive_12), .groups = "drop") %>%
  arrange(ACP_grade) %>%
  mutate(`Li et al. 95% CI` = c("0%", "0 - 11.3%", "19.8 - 44.3%")) %>%
  rename(`ACP grade` = ACP_grade) %>%
  knitr::kable(booktabs = TRUE, caption = "Comparing the 12-day mortality based on ACP score (where available) with the 95\\% confidence intervals (CI) for 12-day mortality reported by Lu et al.")

# acp_data %>%
#   group_by(ACP_grade, worst_breathing_12) %>%
#   summarise(mean(alive_12))
```

The original authors do not report AUC (C-statistic), but they report the overall counts of alive and death patients, letting us compute it. The counts are:

```{r}
auc_data_from_counts <- function(score_values, positive_counts, negative_counts) {
  res <- list()
  for(i in 1:length(score_values)) {
    res[[i]] <- rbind(
      data.frame(score = rep(score_values[i], positive_counts[i]), outcome = rep(TRUE, positive_counts[i])),
      data.frame(score = rep(score_values[i], negative_counts[i]), outcome = rep(FALSE, negative_counts[i]))
    )
  }
  do.call(rbind, res)
}

#Grade 1, 0% mortality,Grade 2, 5.6% mortality, Grade 3, 33.2% mortality
li_et_al_data <-  auc_data_from_counts(c(1,2,3), 
                                            positive_counts = c(194, 145-8, 95-32), 
                                            negative_counts = c(0, 8, 32)) %>%
                         transmute(alive_12 = outcome, ACP_grade = score)

li_et_al_data

```
Giving us this AUC:

```{r}
acp_auc_orig <- my_auc_summary(alive_12 ~ ACP_grade, li_et_al_data)
acp_auc_orig %>% transmute(`C-static` = auc, `95% CI` = paste0("(",auc_low, ", ",auc_high, ")"))

```


So we can now compare AUC computed on our data for both 12-day mortality (as in the original study) and 30-day mortality.

```{r, fig.cap="The AUC and it's 95% credible intervals for the ACP score. The thick blue vertical line marks AUC of 0.5, i.e. the point where reverting the score would yield better predictions. The thin gray dashed line marks the AUC from the original study for easier comparison."}
acp_auc <- rbind(
  my_auc_summary(alive_12 ~ ACP_grade, acp_data),
  my_auc_summary(alive_30 ~ ACP_grade, acp_data)
)
compare_auc_to_orig(acp_auc_orig, acp_auc)

```

```{r}
#acp_auc
```



# Chen and Liu

$$
Score = −4.211+0.013 \times CRP+0.059 \times Age +0.112 \times DD −1.984 \times LYM
$$

The paper does not have units, but the web app

> patients  who  were  with  >10%  missing  values,  stayed  in  the  hospital  <  7  days,  afflicted  by  a  severe  disease  before  admission  (e.g.,  cancer,  aplastic  anemia,  and  uremia),  were  unconscious  at  admission, and were directly admitted to the intensive care unit (ICU) were excluded.

> Non-normally   distributed   continuous   variables   were   transformed   using   a   Box-Cox   transformation.

Slightly unclear how they computed the outcome.

CRP: mg/l
D-dimer: ug / mL FEU (we use ng/ml DDU, FEU value is double the DDU)
Lymphocytes: 10^9 / L

```{r}
data$marker_data %>% filter(marker %in% c("CRP", "d_dimer", "lymphocyte_count")) %>%
  select(marker, unit) %>% distinct()
```



Results for the validation dataset:
AUROC = 0.881
Cutoff (0.5)
Sensitivity = 0.839
Specificity = 0.794




Precise coefficient values and the CI range determined by reverse engineering the webapp at https://phenomics.fudan.edu.cn/risk_scores/


```{r}
chen_liu_data <- data$marker_data_wide %>%  
  mutate(has_all_values = !is.na(CRP) & !is.na(d_dimer) & !is.na(lymphocyte_count),
         d_dimer_converted = d_dimer * 2 / 1000) %>%
  group_by(patient_id) %>%
  filter(any(has_all_values)) %>%
  summarise(
    first_day = min(day[has_all_values]),
    first_CRP = CRP[day == first_day],
    first_d_dimer_converted = d_dimer_converted[day == first_day],
    first_lymphocyte_count = lymphocyte_count[day == first_day],
    breathing_first = breathing[day == first_day],
    .groups = "drop") %>% 
  inner_join(data$patient_data, by = c("patient_id")) %>%
  mutate(    
    inclusion_criterium = breathing_first < "NIPPV" & (outcome %in% c("Discharged", "Death") | last_record >= first_day + 7),
    chen_liu = -4.21167 + 0.058699 * age + 0.013391 * first_CRP + 0.112055 * first_d_dimer_converted - 1.983733 * first_lymphocyte_count,
    risk = 1 / (1 + exp(-chen_liu)),
    risk_lower = 1 / (1 + exp(-chen_liu + 1.96*0.1721)),
    risk_upper = 1 / (1 + exp(-chen_liu - 1.96*0.1721)),
    alive_12 = case_when(last_record >= first_day + 12 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_30 = case_when(last_record >= first_day + 30 | outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_all = case_when(outcome == "Discharged" ~ TRUE,
                         outcome == "Death" ~ FALSE,
                         TRUE ~ NA),
    alive_imputed = outcome != "Death"
    
                         
  ) %>% select(age, starts_with("first"), chen_liu, starts_with("risk"), breathing_first, starts_with("alive"), inclusion_criterium)
```

```{r}
chen_liu_data %>% ggplot(aes(x = chen_liu, y = alive_30)) + geom_point()
```


```{r}
chen_liu_data_inclusion <- chen_liu_data %>% filter(inclusion_criterium)
chen_liu_auc <- rbind(
  my_auc_summary(alive_12 ~ chen_liu, chen_liu_data),
  my_auc_summary(alive_30 ~ chen_liu, chen_liu_data),
  my_auc_summary(alive_all ~ chen_liu, chen_liu_data),
  my_auc_summary(alive_imputed ~ chen_liu, chen_liu_data),
  my_auc_summary(alive_12 ~ chen_liu, chen_liu_data_inclusion, "incl"),
  my_auc_summary(alive_30 ~ chen_liu, chen_liu_data_inclusion, "incl"),
  my_auc_summary(alive_all ~ chen_liu, chen_liu_data_inclusion, "incl"),
  my_auc_summary(alive_imputed ~ chen_liu, chen_liu_data_inclusion, "incl")
)

#plot_all_auc(chen_liu_auc)

```

```{r}
chen_liu_auc_orig <- my_auc_summary_from_estimate(0.881, "alive", "chen_liu", "incl")
compare_auc_to_orig(chen_liu_auc_orig, chen_liu_auc) 

```


# Shi et al.

1 point for Age >= 50, Male, Hypertension

Not sure what "severe" means, will test both "not ventilated", "not needing Oxygen"

```{r}
shi_et_al_data <- data$marker_data_wide %>%  
  group_by(patient_id) %>%
  summarise(
    breathing_admission = max(breathing[!is.na(breathing) & day < 2]),
    not_ventilated_admission = breathing_admission < "NIPPV",
    not_oxygen_admission = breathing_admission < "Oxygen",
    .groups = "drop") %>% 
  inner_join(at_admission, by = c("patient_id")) %>%
  mutate(shi = (age >= 50) + (sex == "M") + has_hypertension_drugs,
         not_ventilated_all = case_when(
           outcome == "Death" ~ FALSE,
           outcome != "Discharged" ~ NA,
           worst_breathing < "NIPPV" ~ TRUE
         ),
         not_oxygen_all = case_when(
           outcome == "Death" ~ FALSE,
           outcome != "Discharged" ~ NA,
           worst_breathing < "Oxygen" ~ TRUE
         )
         )

shi_et_al_auc <- rbind(
  my_auc_summary(alive_12 ~ shi, shi_et_al_data),
  my_auc_summary(alive_30 ~ shi, shi_et_al_data),
  my_auc_summary(not_ventilated_all ~ shi, shi_et_al_data),
  my_auc_summary(not_oxygen_all ~ shi, shi_et_al_data),
  my_auc_summary(not_ventilated_admission ~ shi, shi_et_al_data, subgroup = " (at admission)"),
  my_auc_summary(not_oxygen_admission ~ shi, shi_et_al_data, subgroup = " (at admission)")
)

#plot_all_auc(shi_et_al_auc)
```

From Fig1 B,C:
```{r}
shi_et_al_reported <- data.frame(
  score = c(0,1,2,3), shi_severe_admission = c(0,0.057,0.19,0.4), shi_severe_all = c(0.083, 0.138,0.389,0.429),
  mild_cases_admission = c(118, 199, 98, 21), all_cases_admission = c(118, 211, 121, 35),
  mild_cases_hospitalization = c(11, 25, 11, 4), all_cases_hospitalization = c(12, 29, 18, 7)
) 

# Check that the proportions match
# shi_et_al_reported %>% mutate(sev2 = (all_cases_admission - mild_cases_admission)/all_cases_admission) %>%
#   select(score, shi_severe_admission,sev2)
# 
# shi_et_al_reported %>% mutate(sev2 = (all_cases_hospitalization - mild_cases_hospitalization)/all_cases_hospitalization) %>%
#   select(score, shi_severe_all,sev2)
shie_et_al_auc_data_admission <- auc_data_from_counts(score_values = shi_et_al_reported$score,
                                                      positive_counts = shi_et_al_reported$mild_cases_admission,
                                                      negative_counts = shi_et_al_reported$all_cases_admission - shi_et_al_reported$mild_cases_admission) %>% 
  transmute(shi = score, severe_admission = outcome)

shi_et_al_auc_reported_admission <- my_auc_summary(severe_admission ~ shi, shie_et_al_auc_data_admission, subgroup = " (at admission)")
#shi_et_al_auc_reported_admission$summary

shie_et_al_auc_data_all <- auc_data_from_counts(score_values = shi_et_al_reported$score,
                                                      positive_counts = shi_et_al_reported$mild_cases_hospitalization,
                                                      negative_counts = shi_et_al_reported$all_cases_hospitalization - shi_et_al_reported$mild_cases_hospitalization) %>% 
  transmute(shi = score, severe_hospitalized = outcome)

shi_et_al_auc_reported_all <- my_auc_summary(severe_hospitalized ~ shi, shie_et_al_auc_data_all)
 
compare_auc_to_orig(rbind(shi_et_al_auc_reported_admission, shi_et_al_auc_reported_all), shi_et_al_auc, ncol = 1)
```


```{r}

shi_et_al_compare <- shi_et_al_data %>%
  group_by(shi) %>%
  summarise(
    across(
      one_of(c("not_ventilated_admission", "not_ventilated_all", "not_oxygen_admission", "not_oxygen_all")), 
      ~ mean(.x, na.rm = TRUE), .names = "our_{col}"), 
    n_our_admission = sum(!is.na(not_ventilated_admission)), 
    n_our_all = sum(!is.na(not_ventilated_all)),
    .groups = "drop") %>%
  inner_join(shi_et_al_reported, by = c("shi" = "score"))

shi_et_al_compare %>%
  transmute(score = shi, `Shi et al. (admission)` = shi_severe_admission, `Ventilated (admission)` = 1 - our_not_ventilated_admission, `Oxygen (admission)` = 1 - our_not_oxygen_admission, N = n_our_admission)

shi_et_al_compare %>%
  transmute(score = shi, `Shi et al. (hospitalization)` = shi_severe_all, `Ventilated (hospitalization)` = 1 - our_not_ventilated_all, `Oxygen (hospitalization)` = 1 - our_not_oxygen_all, N = n_our_all)

```


# Caramelo

Uses simulations to get patient-level characterstics from aggregate data.

```{r}
caramelo_data <- at_admission %>%
  mutate(
    caramelo_base = 0 + 
           case_when(age < 20 ~ 0,
                     age < 30 ~ 0.2017,
                     age < 40 ~ 0.3271,
                     age < 50 ~ 5.6030,
                     age < 60 ~ 6.7626,
                     age < 70 ~ 18.8161,
                     age < 80 ~ 43.7291,
                     TRUE ~ 86.8680) +
           if_else(sex == "M", 1.8518, 0) +
           if_else(has_hypertension_drugs, 7.4191, 0) +
           if_else(diabetes, 9.0329, 0),
    caramelo1 = caramelo_base +            
           if_else(heart_failure | ischemic_heart_disease | NYHA > 1, 12.8328, 0) +
           if_else(COPD | asthma, 7.7925, 0),
    caramelo2 = caramelo_base +            
           if_else(heart_failure | ischemic_heart_disease, 12.8328, 0) +
           if_else(COPD, 7.7925, 0)
         )

caramelo_auc <- rbind(
  my_auc_summary(alive_12 ~ caramelo1, caramelo_data),
  my_auc_summary(alive_30 ~ caramelo1, caramelo_data),
  my_auc_summary(alive_12 ~ caramelo2, caramelo_data, outcome_note = "v2"),
  my_auc_summary(alive_30 ~ caramelo2, caramelo_data, outcome_note = "v2"),
  my_auc_summary(alive_12 ~ caramelo_base, caramelo_data, outcome_note = "base"),
  my_auc_summary(alive_30 ~ caramelo_base, caramelo_data, outcome_note = "base")
)

compare_auc_to_orig(tibble(), caramelo_auc)
```



# Bello-Chavolla 

The index given in [@http://zotero.org/users/5567156/items/INZVABQI] is built from following elements:

```{r}
bello_chavolla_table <- rbind(
  data.frame(factor = "Age >= 65 years", score = 3),
  data.frame(factor = "Diabetes", score = 1),
  data.frame(factor = "Diabetes*Age < 40 years", score = 5),
  data.frame(factor = "Age < 40 years", score = -6),
  data.frame(factor = "Obesity", score = 1),
  data.frame(factor = "Pneumonia", score = 7),
  data.frame(factor = "Chronic Kidney Disease", score = 3),
  data.frame(factor = "COPD", score = 1),
  data.frame(factor = "Immunosuppression", score = 1)
)

bello_chavolla_table

```

Of those, our data does not contain Immunosuppresion and Pneumonia. We can however use taking antibiotics within 1 day of hospitalization as an imperfect proxy for pneumonia. We will ignore immunosuppresion in our test. Both of those choices could reduce the performance of the score. 

The authors do not define obesity, so we will use BMI > 30 as threshold for obesity. Our data contains an indicator for "Renal disease" which might be classified slightly differently than "Chronic Kidney Disease".

The authors report C-statistic = 0.830 for mortality on validation dataset - it is unclear how they treat censoring, but they mention 30-day mortality in other part of the paper, so we will focus on 30-day mortality.

```{r}
atb_first_day <- data$marker_data_wide %>% select(patient_id, day, took_antibiotics) %>% 
  group_by(patient_id) %>%
  summarise(atb0 = any(took_antibiotics[day <= 0]), 
            atb1 = any(took_antibiotics[day <= 1]), .groups = "drop")

bello_chavolla_data <- at_admission %>%
  inner_join(atb_first_day, by = "patient_id") %>%
  mutate(bc_base =  3 *  (age >= 65) +
           diabetes +
           5 * (diabetes & age < 40) +
           (-6) * (age < 40) +
           obesity +
           3 * renal_disease +
           COPD,
         bc0 = bc_base + 7 * atb0,
         bc1 = bc_base + 7 * atb1
  )
           

```

```{r}
bello_chavolla_data %>% ggplot(aes(x = bc0, y = as.integer(alive_30))) +
  geom_smooth() + geom_jitter(width = 0.3, height = 0.3) 
bello_chavolla_data %>% ggplot(aes(x = bc_base, y = as.integer(alive_30))) +
  geom_smooth() + geom_jitter(width = 0.3, height = 0.3) 

```


```{r}
bc_auc <- rbind(
  my_auc_summary(alive_30 ~ bc_base, bello_chavolla_data, outcome_note = "base"),
  my_auc_summary(alive_12 ~ bc_base, bello_chavolla_data, outcome_note = "base"),
  my_auc_summary(alive_30 ~ bc0, bello_chavolla_data),
  my_auc_summary(alive_12 ~ bc0, bello_chavolla_data),
  my_auc_summary(alive_30 ~ bc1, bello_chavolla_data, outcome_note = "day1"),
  my_auc_summary(alive_12 ~ bc1, bello_chavolla_data, outcome_note = "day1")
)

bc_auc_orig <- my_auc_summary_from_estimate(0.830, "alive_30", "bc0")

compare_auc_to_orig(bc_auc_orig, bc_auc)
```
# Age only

As a simple baseline we use age in years as the sole predictor.

```{r}
age_auc <-rbind(
  my_auc_summary(alive_30 ~ age, at_admission),
  my_auc_summary(alive_12 ~ age, at_admission)
)

plot_my_auc(alive_30 ~ age, at_admission)
plot_my_auc(alive_12 ~ age, at_admission)

```


# All together now

```{r}
compare_auc_to_orig(rbind(acp_auc_orig, chen_liu_auc_orig, shi_et_al_auc_reported_admission,
                         shi_et_al_auc_reported_all, bc_auc_orig),
                    rbind(acp_auc, chen_liu_auc, shi_et_al_auc, caramelo_auc, bc_auc), show_outcome = FALSE)

```

