---
title: "HMM Model development"
output: html_notebook
---


```{r setup}
library(rstan)
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

devtools::load_all()
```


```{r}
data <- hmm_simulator(10, 20, 4, use_noisy_states = TRUE)

improving_data <- data.frame(day = data$observed$times, patient = data$observed$series, improving = data$true$true_improving) %>% filter(improving)

data.frame(day = data$observed$times, patient = data$observed$series, breathing = data$true$true_base_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + geom_tile(data = improving_data, width = 1, height = 0.1, fill = "gray") + ggtitle("True - gray lines for improving")


data.frame(day = data$observed$times, patient = data$observed$series, breathing = data$observed$obs_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + ggtitle("Observed")
```


```{r}
adapt_delta <- 0.9

data <- hmm_simulator(30, 20, 2, use_noisy_states = TRUE)

single_code <- make_stancode_hmm(data$observed_structured$formula, serie_data = data$observed_structured$serie_data, rate_data = data$observed_structured$rate_data, state_data = data$observed_structured$state_data, prior= data$observed_structured$prior)

model_single <- stan_model(model_code = single_code)

prepdata <- make_data_hmm(data$observed_structured$formula, serie_data = data$observed_structured$serie_data, rate_data = data$observed_structured$rate_data, state_data = data$observed_structured$state_data, sensitivity_low_bound = data$observed$sensitivity_low_bound)


standata <- make_standata_hmm(data$observed_structured$formula, serie_data = data$observed_structured$serie_data, rate_data = data$observed_structured$rate_data, state_data = data$observed_structured$state_data, sensitivity_low_bound = data$observed$sensitivity_low_bound)


if(inherits(model_single, "stanmodel")) {
  fit <- sampling(model_single, data = standata, control = list(adapt_delta = adapt_delta))
} else {
  cmdstan_fit <- model_single$sample(data = standata, adapt_delta = adapt_delta)
  fit <- rstan::read_stan_csv(cmdstan_fit$output_files())
}
evaluation_summary(fit, data$true)

```

```{r}
noisy_states_in_sbc <- FALSE
sbc_generator <- function() {
  data <- hmm_simulator(50, 20, 3, use_noisy_states = noisy_states_in_sbc)
  standata <- make_standata_hmm(data$observed_structured$formula, serie_data = data$observed_structured$serie_data, rate_data = data$observed_structured$rate_data, state_data = data$observed_structured$state_data, sensitivity_low_bound = data$observed$sensitivity_low_bound)

  list(observed = standata,
       true = data$true)
}

sbc_res <- sbc(model_single, generator = sbc_generator, N_steps = 200, control = list(adapt_delta = adapt_delta))

saveRDS(sbc_res, "sbc.rds")

sbc_res$params %>% filter(grepl("b|sd", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("r_1", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("r_2", param_name)) %>% plot_sbc_params()
if(noisy_states_in_sbc) {
  sbc_res$params %>% filter(grepl("sensitivity", param_name)) %>% plot_sbc_params()
  sbc_res$params %>% filter(grepl("other_observations_probs", param_name)) %>% plot_sbc_params()
}

#sbc_res$params %>% plot_sbc_params()
summarise_sbc_diagnostics(sbc_res)
sbc_res$diagnostics

```



```{r}
library(brms)
```

```{r}
```


```{r}

test_data <- data.frame(a = c(1,2,3), b = c(0.5,1.0,1.5), x1 = c("A"), x2 = c(0,1,2))
f <- a ~ 0 + (0 + x2 | a | x1)
# make_stancode(f, data = test_data)
#brms::make_standata(f, data = test_data)
xx <- brms::brmsformula(f)

xx$resp



stan_llh.rate_hmm <- function( ... ) {
  ""
}

.family_rate_hmm <- function() {
  
}

ff <- 

make_stancode(a ~ 0 + x2, family = ff, data = test_data)


```

