---
title: "HMM Model development"
output: html_notebook
---


```{r setup}
library(rstan)
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

devtools::load_all()
```


```{r}
data <- hmm_simulator(10, 20, 4, use_noisy_states = TRUE)

improving_data <- data.frame(day = data$observed$times, patient = data$observed$patients, improving = data$true$true_improving) %>% filter(improving)

data.frame(day = data$observed$times, patient = data$observed$patients, breathing = data$true$true_base_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + geom_tile(data = improving_data, width = 1, height = 0.1, fill = "gray") + ggtitle("True - gray lines for improving")


data.frame(day = data$observed$times, patient = data$observed$patients, breathing = data$observed$obs_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + ggtitle("Observed")
```

```{r}
model <- stan_model(here::here("hmm.stan"))
```

```{r}
adapt_delta <- 0.8

data <- hmm_simulator(10, 20, 2, use_noisy_states = TRUE)

if(inherits(model, "stanmodel")) {
  fit <- sampling(model, data = data$observed, control = list(adapt_delta = adapt_delta))
} else {
  cmdstan_fit <- model$sample(data = data$observed, adapt_delta = adapt_delta)
  fit <- rstan::read_stan_csv(cmdstan_fit$output_files())
}
evaluation_summary(fit, data$true)

```

```{r}
sbc_res <- sbc(model, generator = function() {hmm_simulator(10, 20, 2, use_noisy_states = FALSE) }, N_steps = 100, control = list(adapt_delta = adapt_delta))

saveRDS(sbc_res, "sbc.rds")

sbc_res$params %>% filter(grepl("rates", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("sensitivity", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("other_observations_probs", param_name)) %>% plot_sbc_params()

#sbc_res$params %>% plot_sbc_params()
summarise_sbc_diagnostics(sbc_res)
sbc_res$diagnostics

```


```{r}
library(brms)
test_data <- data.frame(a = c(1,2,3), b = c(0.5,1.0,1.5), x1 = c("A"), x2 = c(0,1,2))
f <- cbind(a,b) ~ 0 + (0 + x2 | a | x1)
make_stancode(f, data = test_data)
make_standata(f, data = test_data)
```

