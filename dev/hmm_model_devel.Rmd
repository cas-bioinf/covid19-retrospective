---
title: "HMM Model development"
output: html_notebook
---


```{r setup}
library(rstan)
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

devtools::load_all()
```


```{r}
data <- hmm_simulator(10, 20, 4, use_noisy_states = TRUE)

improving_data <- data.frame(day = data$observed$times, patient = data$observed$series, improving = data$true$true_improving) %>% filter(improving)

data.frame(day = data$observed$times, patient = data$observed$series, breathing = data$true$true_base_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + geom_tile(data = improving_data, width = 1, height = 0.1, fill = "gray") + ggtitle("True - gray lines for improving")


data.frame(day = data$observed$times, patient = data$observed$series, breathing = data$observed$obs_states) %>%
  mutate(breathing = factor(breathing, 1:data$observed$N_states_observed, ordered = TRUE)) %>%
  ggplot(aes(x = day, y = patient, fill = breathing)) + geom_tile(width = 1, height = 0.5) + ggtitle("Observed")
```


```{r}
adapt_delta <- 0.9

data <- hmm_simulator(5, 10, 2, use_noisy_states = TRUE)

single_code <- make_stancode_hmm(data$observed$formula, 
                                 serie_data = data$observed$serie_data, 
                                 rate_data = data$observed$rate_data, 
                                 hidden_state_data = data$observed$hidden_state_data, 
                                 initial_states = data$observed$initial_states,
                                 observed_state_data = data$observed$observed_state_data,
                                 prior= data$observed$prior)

model_single <- stan_model(model_code = single_code)


standata <- make_standata_hmm(data$observed$formula, 
                              serie_data = data$observed$serie_data, 
                              rate_data = data$observed$rate_data, 
                              hidden_state_data = data$observed$hidden_state_data, 
                              initial_states = data$observed$initial_states,
                              observed_state_data = data$observed$observed_state_data,
                              sensitivity_low_bound = data$observed$sensitivity_low_bound)


if(inherits(model_single, "stanmodel")) {
  fit <- sampling(model_single, data = standata, control = list(adapt_delta = adapt_delta))
} else {
  cmdstan_fit <- model_single$sample(data = standata, adapt_delta = adapt_delta)
  fit <- rstan::read_stan_csv(cmdstan_fit$output_files())
}
evaluation_summary(fit, data$true)

```

```{r}

prepdata <- make_data_hmm(data$observed$formula, 
                              serie_data = data$observed$serie_data, 
                              rate_data = data$observed$rate_data, 
                              hidden_state_data = data$observed$hidden_state_data, 
                              initial_states = data$observed$initial_states,
                              observed_state_data = data$observed$observed_state_data,
                              sensitivity_low_bound = data$observed$sensitivity_low_bound)

bfit <- brm(formula = make_brms_formula_hmm(data$observed$formula), family = rate_hmm_family, data = prepdata$brmsdata, prior = data$observed$prior, stanvars = rate_hmm_stanvars(prepdata$standata))

bfit <- brms:::brmsfit(formula = make_brms_formula_hmm(data$observed$formula), data = prepdata$brmsdata, prior = data$observed$prior, stanvars = rate_hmm_stanvars(prepdata$standata), fit = fit)

bfit

posterior_epred(bfit)

brms::make_standata(formula = make_brms_formula_hmm(data$observed$formula), family = rate_hmm_family, data = prepdata$brmsdata, prior = data$observed$prior, stanvars = rate_hmm_stanvars(prepdata$standata))

```


```{r}
noisy_states_in_sbc <- TRUE
sbc_generator <- function() {
  data <- hmm_simulator(20, 15, 2, use_noisy_states = noisy_states_in_sbc)
  standata <- make_standata_hmm(data$observed$formula, 
                                serie_data = data$observed$serie_data, 
                                rate_data = data$observed$rate_data, 
                                hidden_state_data = data$observed$hidden_state_data, 
                                initial_states = data$observed$initial_states,
                                observed_state_data = data$observed$observed_state_data,
                                sensitivity_low_bound = data$observed$sensitivity_low_bound)

  list(observed = standata,
       true = data$true)
}

sbc_res <- sbc(model_single, generator = sbc_generator, N_steps = 50, control = list(adapt_delta = adapt_delta))

saveRDS(sbc_res, "sbc.rds")

sbc_res$params %>% filter(grepl("b|sd", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("r_1", param_name)) %>% plot_sbc_params()
sbc_res$params %>% filter(grepl("r_2", param_name)) %>% plot_sbc_params()
if(noisy_states_in_sbc) {
  sbc_res$params %>% filter(grepl("sensitivity", param_name)) %>% plot_sbc_params()
  sbc_res$params %>% filter(grepl("other_observations_probs", param_name)) %>% plot_sbc_params()
}

#sbc_res$params %>% plot_sbc_params()
summarise_sbc_diagnostics(sbc_res)
sbc_res$diagnostics

```



## Apply to Grein et al. dataset

```{r}

  breathing_data_orig <- readxl::read_excel(here::here("public_data", "Grein_et_al.xlsx"), na = c("")) %>%
    select(-Remdesivir_Last_Day) %>%
    pivot_longer(starts_with("Day_"), names_prefix = "Day_", names_to = "day", values_to = "breathing") %>%
    filter(!is.na(breathing)) %>%
    transmute(
      patient = Patient,
      breathing = if_else(breathing %in% c("LoO2", "HiO2"), "Oxygen", breathing),
      day = as.integer(day)) %>%
    group_by(patient) %>%
    mutate(breathing = if_else(breathing == "ND", breathing[which.max(day[breathing %in% c("AA", "Oxygen", "NIPPV", "MV", "ECMO")])], breathing)) %>%
    ungroup() %>%
    mutate(
      breathing = factor(breathing, levels = c("Discharge", "AA", "Oxygen", "NIPPV", "MV", "ECMO", "Death"), ordered = TRUE)
    )

```
